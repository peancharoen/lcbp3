name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest # âš ï¸ à¸•à¹‰à¸­à¸‡à¸•à¸£à¸‡à¸à¸±à¸š Label à¸‚à¸­à¸‡ Runner à¹ƒà¸™ Gitea Settings (à¹€à¸Šà¹ˆà¸™ self-hosted)
    steps:
      - name: Deploy to QNAP via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script_stop_signal: true # Stop script on error
          script: |
            # âš ï¸ QNAP SSH à¹„à¸¡à¹ˆà¸¡à¸µ PATH à¹€à¸•à¹‡à¸¡ à¸•à¹‰à¸­à¸‡ export à¹€à¸­à¸‡
            # docker: /share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker
            # git:    /opt/bin/git
            export PATH="/share/CACHEDEV1_DATA/.qpkg/container-station/bin:/opt/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

            echo "ğŸš€ Starting Deployment..."

            # 1. Update Code
            echo "ğŸ“‚ Pulling latest code..."
            cd /share/np-dms/app/source/lcbp3
            git pull origin main

            # 2. Build Backend
            echo "ğŸ—ï¸ Building Backend..."
            docker build -f backend/Dockerfile -t lcbp3-backend:latest .

            # 3. Build Frontend
            echo "ğŸ—ï¸ Building Frontend..."
            docker build -f frontend/Dockerfile \
              --build-arg NEXT_PUBLIC_API_URL=https://backend.np-dms.work/api \
              -t lcbp3-frontend:latest .

            # 4. Update Containers
            echo "ğŸ”„ Updating Containers..."
            cd /share/np-dms/app
            # âš ï¸ à¸¥à¸š container à¹€à¸”à¸´à¸¡à¸—à¸µà¹ˆà¸­à¸²à¸ˆà¸ªà¸£à¹‰à¸²à¸‡à¸ˆà¸²à¸ Container Station
            docker rm -f backend frontend 2>/dev/null || true

            # 4a. Start Backend à¸à¹ˆà¸­à¸™
            echo "ğŸŸ¢ Starting Backend..."
            docker compose -f docker-compose-app.yml up -d backend

            # 4b. à¸£à¸­ Backend healthy (à¸—à¸¸à¸ 5 à¸§à¸´ à¸ªà¸¹à¸‡à¸ªà¸¸à¸” 60 à¸§à¸´)
            echo "â³ Waiting for Backend health check..."
            for i in $(seq 1 12); do
              if docker inspect --format='{{.State.Health.Status}}' backend 2>/dev/null | grep -q healthy; then
                echo "âœ… Backend is healthy!"
                break
              fi
              if [ "$i" = "12" ]; then
                echo "âš ï¸ Backend health check timeout - starting frontend anyway"
              fi
              sleep 5
            done

            # 4c. Start Frontend
            echo "ğŸŸ¢ Starting Frontend..."
            docker compose -f docker-compose-app.yml up -d frontend

            # 5. Cleanup
            echo "ğŸ§¹ Cleaning up unused images..."
            docker image prune -f

            echo "âœ… Deployment Complete!"
