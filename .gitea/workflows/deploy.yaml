name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest # ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Label ‡∏Ç‡∏≠‡∏á Runner ‡πÉ‡∏ô Gitea Settings (‡πÄ‡∏ä‡πà‡∏ô self-hosted)
    steps:
      - name: Deploy to QNAP via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script_stop_signal: true # Stop script on error
          script: |
            # ‚ö†Ô∏è QNAP SSH ‡πÑ‡∏°‡πà‡∏°‡∏µ PATH ‡πÄ‡∏ï‡πá‡∏° ‡∏ï‡πâ‡∏≠‡∏á export ‡πÄ‡∏≠‡∏á
            # docker: /share/CACHEDEV1_DATA/.qpkg/container-station/bin/docker
            # git:    /opt/bin/git
            export PATH="/share/CACHEDEV1_DATA/.qpkg/container-station/bin:/opt/bin:/usr/local/bin:/usr/bin:/bin:$PATH"

            echo "üöÄ Starting Deployment..."

            # 1. Update Code
            echo "üìÇ Pulling latest code..."
            cd /share/np-dms/app/source/lcbp3
            git pull origin main

            # 2. Build Backend
            echo "üèóÔ∏è Building Backend..."
            docker build -f backend/Dockerfile -t lcbp3-backend:latest .

            # 3. Build Frontend
            echo "üèóÔ∏è Building Frontend..."
            docker build -f frontend/Dockerfile \
              --build-arg NEXT_PUBLIC_API_URL=https://backend.np-dms.work/api \
              -t lcbp3-frontend:latest .

            # 4. Update Containers
            echo "üîÑ Updating Containers..."
            cd /share/np-dms/app
            docker compose -f docker-compose-app.yml up -d

            # 5. Cleanup
            echo "üßπ Cleaning up unused images..."
            docker image prune -f

            echo "‚úÖ Deployment Complete!"
