## 3.11.15. Database Schema Requirements

### 3.11.15.1. Counter Table Schema

‡∏ï‡∏≤‡∏£‡∏≤‡∏á `document_number_counters` ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

```sql
CREATE TABLE document_number_counters (
  project_id INT NOT NULL,
  originator_organization_id INT NOT NULL,
  recipient_organization_id INT NULL,  -- NULL for RFA
  correspondence_type_id INT NOT NULL,
  sub_type_id INT DEFAULT 0,           -- for TRANSMITTAL
  rfa_type_id INT DEFAULT 0,           -- for RFA
  discipline_id INT DEFAULT 0,         -- for RFA
  current_year INT NOT NULL,
  version INT DEFAULT 0 NOT NULL,      -- Optimistic Lock
  last_number INT DEFAULT 0,

  PRIMARY KEY (
    project_id,
    originator_organization_id,
    COALESCE(recipient_organization_id, 0),
    correspondence_type_id,
    sub_type_id,
    rfa_type_id,
    discipline_id,
    current_year
  ),

  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  FOREIGN KEY (originator_organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
  FOREIGN KEY (recipient_organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
  FOREIGN KEY (correspondence_type_id) REFERENCES correspondence_types(id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_general_ci
  COMMENT = '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö Running Number Counters';
```

### 3.11.15.2. Index Requirements

```sql
-- Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Performance
CREATE INDEX idx_counter_lookup
ON document_number_counters (
  project_id,
  correspondence_type_id,
  current_year
);

-- Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Originator lookup
CREATE INDEX idx_counter_org
ON document_number_counters (
  originator_organization_id,
  current_year
);
```

### 3.11.15.3. Important Notes

> **üí° Counter Key Design**
> - ‡πÉ‡∏ä‡πâ `COALESCE(recipient_organization_id, 0)` ‡πÉ‡∏ô Primary Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö NULL
> - `version` column ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Optimistic Locking (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition)
> - `last_number` ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0 ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡∏•‡∏∞ 1
> - Counter reset ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡πÄ‡∏°‡∏∑‡πà‡∏≠ `current_year` ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)

> **‚ö†Ô∏è Migration Notes**
> - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ backward compatibility
> - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á table ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ï‡∏≤‡∏° schema ‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô
> - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ seed data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö `correspondence_types`, `rfa_types`, `disciplines` ‡∏Å‡πà‡∏≠‡∏ô

### 3.11.15.4. Example Counter Records

```sql
-- Example: LETTER from ‡∏Ñ‡∏Ñ‡∏á. to ‡∏™‡∏Ñ‡∏â.3 in LCBP3-C2 year 2025
INSERT INTO document_number_counters (
  project_id, originator_organization_id, recipient_organization_id,
  correspondence_type_id, sub_type_id, rfa_type_id, discipline_id,
  current_year, version, last_number
) VALUES (
  2,      -- LCBP3-C2
  22,     -- ‡∏Ñ‡∏Ñ‡∏á.
  10,     -- ‡∏™‡∏Ñ‡∏â.3
  6,      -- LETTER
  0, 0, 0,
  2025, 0, 0
);

-- Example: RFA from ‡∏ú‡∏£‡∏°.2 in LCBP3-C2, discipline TER, type RPT, year 2025
INSERT INTO document_number_counters (
  project_id, originator_organization_id, recipient_organization_id,
  correspondence_type_id, sub_type_id, rfa_type_id, discipline_id,
  current_year, version, last_number
) VALUES (
  2,      -- LCBP3-C2
  42,     -- ‡∏ú‡∏£‡∏°.2
  NULL,   -- RFA ‡πÑ‡∏°‡πà‡∏°‡∏µ specific recipient
  1,      -- RFA
  0,
  18,     -- RPT (Report)
  5,      -- TER (Terminal)
  2025, 0, 0
);
```
