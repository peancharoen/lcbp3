# File: /share/np-dms/app/docker-compose.yml
# DMS Container v1.8.0: Application Stack (Backend + Frontend)
# Application name: lcbp3-app
# ============================================================
# ‚ö†Ô∏è  ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö services ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏ô QNAP:
#     - mariadb (lcbp3-db)
#     - cache   (services)
#     - search  (services)
#     - npm     (lcbp3-npm)
# ============================================================
# üîí SECURITY: ‡∏´‡πâ‡∏≤‡∏° commit ‡∏Ñ‡πà‡∏≤ secrets ‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
#              ‡πÉ‡∏ä‡πâ Environment Variables ‡πÉ‡∏ô Container Station UI
# ============================================================

x-restart: &restart_policy
  restart: unless-stopped

x-logging: &default_logging
  logging:
    driver: 'json-file'
    options:
      max-size: '10m'
      max-file: '5'

networks:
  lcbp3:
    external: true

services:
  # ----------------------------------------------------------------
  # 1. Backend API (NestJS)
  # Service Name: backend (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà NPM ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ‚Üí backend:3000)
  # ----------------------------------------------------------------
  backend:
    <<: [*restart_policy, *default_logging]
    image: lcbp3-backend:latest
    container_name: backend
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 512M
    environment:
      TZ: 'Asia/Bangkok'
      NODE_ENV: 'production'
      # --- Database ---
      DB_HOST: 'mariadb'
      DB_PORT: '3306'
      DB_DATABASE: 'lcbp3'
      DB_USERNAME: 'center'
      DB_PASSWORD: '<SET_IN_CONTAINER_STATION>'
      # --- Redis ---
      REDIS_HOST: 'cache'
      REDIS_PORT: '6379'
      REDIS_PASSWORD: '<SET_IN_CONTAINER_STATION>'
      # --- Elasticsearch ---
      ELASTICSEARCH_HOST: 'search'
      ELASTICSEARCH_PORT: '9200'
      # --- JWT ---
      JWT_SECRET: '<SET_IN_CONTAINER_STATION>'
      JWT_EXPIRATION: '8h'
      JWT_REFRESH_SECRET: '<SET_IN_CONTAINER_STATION>'
      # --- Numbering ---
      NUMBERING_LOCK_TIMEOUT: '5000'
      NUMBERING_RESERVATION_TTL: '300'
      # --- File Upload ---
      UPLOAD_TEMP_DIR: '/app/uploads/temp'
      UPLOAD_PERMANENT_DIR: '/app/uploads/permanent'
      MAX_FILE_SIZE: '52428800'
    networks:
      - lcbp3
    volumes:
      # Two-Phase Storage: ‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≠‡∏Å container
      - '/share/np-dms/data/uploads/temp:/app/uploads/temp'
      - '/share/np-dms/data/uploads/permanent:/app/uploads/permanent'
      - '/share/np-dms/data/logs/backend:/app/logs'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ----------------------------------------------------------------
  # 2. Frontend Web App (Next.js)
  # Service Name: frontend (‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà NPM ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á ‚Üí frontend:3000)
  # ----------------------------------------------------------------
  frontend:
    <<: [*restart_policy, *default_logging]
    image: lcbp3-frontend:latest
    container_name: frontend
    stdin_open: true
    tty: true
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M
    environment:
      TZ: 'Asia/Bangkok'
      NODE_ENV: 'production'
      HOSTNAME: '0.0.0.0'
      PORT: '3000'
      # --- NextAuth ---
      AUTH_SECRET: '<SET_IN_CONTAINER_STATION>'
      AUTH_URL: 'https://lcbp3.np-dms.work'
    networks:
      - lcbp3
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      backend:
        condition: service_healthy
