# 3.11 Document Numbering Management (‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)

---
title: 'Functional Requirements: Document Numbering Management'
version: 1.6.2
status: draft
owner: Nattanin Peancharoen
last_updated: 2025-12-17
related:
  - specs/01-requirements/01-objectives.md
  - specs/01-requirements/02-architecture.md
  - specs/01-requirements/03unctional-requirements.md
  - specs/03-implementation/document-numbering.md
  - specs/04-operations/document-numbering-operations.md
  - specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md
  - specs/05-decisions/adr-018-document-numbering.md
Clean Version v1.6.2 ‚Äì Scope of Changes:
  - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ Single Numbering System (Option A)
  - ‡πÅ‡∏Å‡πâ Primary Key design ‡πÉ‡∏´‡πâ implement ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á
  - ‡∏õ‡∏£‡∏±‡∏ö Character Rule ‡πÄ‡∏õ‡πá‡∏ô UTF‚Äë8 printable
  - Bind Reset Policy ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (Yearly reset, RFA no reset)
  - ‡πÄ‡∏û‡∏¥‡πà‡∏° Number State Machine
  - ‡πÄ‡∏û‡∏¥‡πà‡∏° Idempotency Key
  - Drawing ‡πÉ‡∏ä‡πâ separate counter namespace
  - ‡πÄ‡∏û‡∏¥‡πà‡∏° Formal Token Validation Grammar
---

> **üìñ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á**
>
> - **Implementation Guide**: [document-numbering.md](file:///d:/nap-dms.lcbp3/specs/03-implementation/document-numbering.md) - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£ implement ‡∏î‡πâ‡∏ß‡∏¢ NestJS, TypeORM, Redis
> - **Operations Guide**: [document-numbering-operations.md](file:///d:/nap-dms.lcbp3/specs/04-operations/document-numbering-operations.md) - Monitoring, Troubleshooting, Maintenance Procedures

---

## 3.11.1 Overview & ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå

### 3.11.1.1 Purpose

‡∏£‡∏∞‡∏ö‡∏ö Document Numbering ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (unique) ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÑ‡∏î‡πâ (traceable) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö LCBP3-DMS

### 3.11.1.2 Requirements Summary

- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Running Number) ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥, ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå (unique) ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (template) ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô Uniqueness ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö concurrent ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

### 3.11.1.3 Scope

- Auto-generation ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- Manual override ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ import ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤
- Cancelled number handling (‡πÑ‡∏°‡πà reuse)
- Void & Replace pattern ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- Distributed locking ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition
- Complete audit trail ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å operation

### 3.11.1.4 Document Types Supported

- Request for Approvals (RFA)
- Request for Information (RFI)
- Transmittal (TRANSMITTAL)
- Email (EMAIL)
- Instruction (INSTRUCTION)
- Letter (LETTER)
- Memorandum (MEMO)
- Minutes of Meeting (MOM)
- Notice (NOTICE)
- Other (OTHER)
- Contract Drawings (COD)
- Shop Drawings (SHD)
- Circulation Sheets (CIR)

### 3.11.1.5 Architectural Decision (Updated)
AD-DN-001: Single Source of Truth for Numbering ‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ Option A:
  - document_number_counters ‡πÄ‡∏õ‡πá‡∏ô Core / Authoritative Counter System
  - document_numbering_configs ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞:
    - Template format
    - Permission / policy
  - ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ document_numbering_sequences ‡πÄ‡∏õ‡πá‡∏ô counter ‡∏à‡∏£‡∏¥‡∏á
‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•: ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô, ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô counter mismatch, debug ‡∏á‡πà‡∏≤‡∏¢, ops ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
---
## 3.11.2 Counter Logic & Reset Policy
### 3.11.2 Counter Logic (Logic ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç)

‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° **Counter Key** ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£

| Document Type | Reset Policy |
| ------------- | ------------ |
| Correspondence (LETTER, MEMO, RFI, etc.) | Yearly reset |
| Transmittal | Yearly reset |
| RFA | No reset (continuous) |
| Drawing | Separate namespace (see 3.11.8) |

### 3.11.2.2 Counter Key Fields (Revised)
```
(project_id,
 originator_organization_id,
 recipient_organization_id,
 correspondence_type_id,
 sub_type_id,
 rfa_type_id,
 discipline_id,
 reset_scope)
```

* `reset_scope`:
  * `YEAR_2025`, `YEAR_2026`, ...
  * `NONE` (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFA)

### 3.11.2.3 Counter Key Components

| Component                    | Required?        | Description         | Database Source                                           | Default if NULL |
| ---------------------------- | ---------------- | ------------------- | --------------------------------------------------------- | --------------- |
| `project_id`                 | ‚úÖ Yes            | ID ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£          | Derived from user context or organization                 | -               |
| `originator_organization_id` | ‚úÖ Yes            | ID ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á         | `correspondences.originator_id`                           | -               |
| `recipient_organization_id`  | Depends on type  | ID ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO) | `correspondence_recipients` where `recipient_type = 'TO'` | 0 for RFA       |
| `correspondence_type_id`     | ‚úÖ Yes            | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£     | `correspondence_types.id`                                 | 0               |
| `sub_type_id`                | TRANSMITTAL only | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢        | `correspondence_sub_types.id`                             | 0               |
| `rfa_type_id`                | RFA only         | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA       | `rfa_types.id`                                            | 0               |
| `discipline_id`              | RFA only         | ID ‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô          | `disciplines.id`                                          | 0               |
| `reset_scope`                | ‚úÖ Yes            | ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï reset        | System derived                                            | -               |

### 3.11.2.4 Counter Key by Document Type

#### **Global (LETTER / MEMO / RFI / EMAIL / INSTRUCTION / NOTICE / OTHER)**:
```
(project_id, originator_organization_id, recipient_organization_id,
 correspondence_type_id, 0, 0, 0, 'YEAR_2025')
```

**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏**:
- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ `discipline_id`, `sub_type_id`, `rfa_type_id`
- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° correspondence type ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô `correspondence_types` table ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Template ‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

#### **TRANSMITTAL**:
```
(project_id, originator_organization_id, recipient_organization_id,
 correspondence_type_id, sub_type_id, 0, 0, 'YEAR_2025')
```

*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏*: ‡πÉ‡∏ä‡πâ `sub_type_id` ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

#### **RFA**:
```
(project_id, originator_organization_id, 0,
 correspondence_type_id, 0, rfa_type_id, discipline_id, 'NONE')
```

*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏*:
- RFA ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ `recipient_organization_id` (‡πÉ‡∏ä‡πâ 0) ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (CONTRACTOR ‚Üí CONSULTANT ‚Üí OWNER)
- ‡πÑ‡∏°‡πà‡∏°‡∏µ yearly reset (`reset_scope = 'NONE'`)

### 3.11.2.5 ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏≤ project_id

‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Template ‡∏Ç‡∏≠‡∏á LETTER/TRANSMITTAL ‡πÑ‡∏°‡πà‡∏°‡∏µ `{PROJECT}` token ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤ `project_id` ‡∏à‡∏≤‡∏Å:

1. **User Context** (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥):
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠ User ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ UI ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Project/Contract ‡∏Å‡πà‡∏≠‡∏ô
   - ‡πÉ‡∏ä‡πâ `project_id` ‡∏à‡∏≤‡∏Å Context ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

2. **‡∏à‡∏≤‡∏Å Organization**:
   - Query `project_organizations` ‡∏´‡∏£‡∏∑‡∏≠ `contract_organizations`
   - ‡πÉ‡∏ä‡πâ `originator_organization_id` ‡∏´‡∏≤ project ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
   - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ project ‡πÉ‡∏´‡πâ User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

3. **Validation**:
   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ organization ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô project ‡∏ô‡∏±‡πâ‡∏ô
   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ project/contract ‡πÄ‡∏õ‡πá‡∏ô active

### 3.11.2.6 Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ NULL

- `correspondence_type_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)
- `discipline_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô)
- `sub_type_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢)
- `rfa_type_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA)
- `recipient_organization_id`: ‡πÉ‡∏ä‡πâ `0` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFA, Required ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LETTER/TRANSMITTAL

---

## 3.11.3 Format Templates by Correspondence Type

> **üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**
> - Templates ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å
> - ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö **‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£** ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô `correspondence_types` table
> - ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
> - Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Template ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡πà‡∏≤‡∏ô Admin Panel

### 3.11.3.1 Global (correspondence_type_id = defined)

**Template**:
```
{ORIGINATOR}-{RECIPIENT}-{SEQ:4}-{YEAR:B.E.}
```

**Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-0001-2568`

**Token Breakdown**:

- `‡∏Ñ‡∏Ñ‡∏á.` = {ORIGINATOR} = ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á
- `‡∏™‡∏Ñ‡∏â.3` = {RECIPIENT} = ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO)
- `0001` = {SEQ:4} = Running number (‡πÄ‡∏£‡∏¥‡πà‡∏° 0001, 0002, ...)
- `2568` = {YEAR:B.E.} = ‡∏õ‡∏µ ‡∏û.‡∏®.

> **‚ö†Ô∏è Template vs Counter Separation**
>
> - {CORR_TYPE} **‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á**‡πÉ‡∏ô template ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
> - ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö**‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ correspondence_type_id ‡πÉ‡∏ô Counter Key** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å counter
> - LETTER, MEMO, RFI **‡∏°‡∏µ counter ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô** ‡πÅ‡∏°‡πâ template format ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

**Counter Key**: `(project_id, originator_org_id, recipient_org_id, correspondence_type_id, 0, 0, 0, 'YEAR_2025')`

---

### 3.11.3.2 Transmittal (TYPE = TRANSMITTAL)

**Template**:
```
{ORIGINATOR}-{RECIPIENT}-{SUB_TYPE}-{SEQ:4}-{YEAR:B.E.}
```

**Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-21-0117-2568`

**Token Breakdown**:

- `‡∏Ñ‡∏Ñ‡∏á.` = {ORIGINATOR}
- `‡∏™‡∏Ñ‡∏â.3` = {RECIPIENT}
- `21` = {SUB_TYPE} = ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ (11=MAT, 12=SHP, 13=DWG, 14=MET, ...)
- `0117` = {SEQ:4}
- `2568` = {YEAR:B.E.}

**Counter Key**: `(project_id, originator_org_id, recipient_org_id, correspondence_type_id, sub_type_id, 0, 0, 'YEAR_2025')`

---

### 3.11.3.3 RFA (Request for Approval)

**Example**: `LCBP3-C2-RFA-TER-RPT-0001-A`

**Token Breakdown**:

- `LCBP3-C2` = {PROJECT} = ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
- `RFA` = {CORR_TYPE} = ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (**‡πÅ‡∏™‡∏î‡∏á**‡πÉ‡∏ô RFA template)
- `TER` = {DISCIPLINE} = ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô (TER=Terminal, STR=Structure, ...)
- `RPT` = {RFA_TYPE} = ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA (RPT=Report, SDW=Shop Drawing, ...)
- `0001` = {SEQ:4}
- `A` = {REV} = Revision code

> **üìã RFA Workflow**
>
> - RFA ‡πÄ‡∏õ‡πá‡∏ô **‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£** (Project-level document)
> - Workflow: **CONTRACTOR ‚Üí CONSULTANT ‚Üí OWNER**
> - ‡πÑ‡∏°‡πà‡∏°‡∏µ specific `recipient_id` ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô workflow ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß

**Counter Key**: `(project_id, originator_org_id, 0, correspondence_type_id, 0, rfa_type_id, discipline_id, 'NONE')`


---


### 3.11.3.4 Drawing

**Status**: üöß **To Be Determined**

Drawing Numbering ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Template ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å:

- ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏™‡∏π‡∏á (Contract Drawing ‡πÅ‡∏•‡∏∞ Shop Drawing ‡∏°‡∏µ‡∏Å‡∏é‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)
- ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Numbering ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
- ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö RFA ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

---

## 3.11.4 Supported Token Types

| Token          | Description                  | Example                        | Database Source                                                                                 |
| -------------- | ---------------------------- | ------------------------------ | ----------------------------------------------------------------------------------------------- |
| `{PROJECT}`    | ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£                   | `LCBP3`, `LCBP3-C2`            | `projects.project_code`                                                                         |
| `{ORIGINATOR}` | ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á                  | `‡∏Ñ‡∏Ñ‡∏á.`, `‡∏ú‡∏£‡∏°.1`                | `organizations.organization_code` via `correspondences.originator_id`                           |
| `{RECIPIENT}`  | ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO)          | `‡∏™‡∏Ñ‡∏â.3`, `‡∏Å‡∏ó‡∏ó.`                | `organizations.organization_code` via `correspondence_recipients` where `recipient_type = 'TO'` |
| `{CORR_TYPE}`  | ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£              | `RFA`, `TRANSMITTAL`, `LETTER` | `correspondence_types.type_code`                                                                |
| `{SUB_TYPE}`   | ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢             | `11`, `12`, `21`               | `correspondence_sub_types.sub_type_number`                                                      |
| `{RFA_TYPE}`   | ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA                | `SDW`, `RPT`, `MAT`            | `rfa_types.type_code`                                                                           |
| `{DISCIPLINE}` | ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤                   | `STR`, `TER`, `GEO`            | `disciplines.discipline_code`                                                                   |
| `{SEQ:n}`      | Running number (n = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å) | `0001`, `0029`, `0985`         | Based on `document_number_counters.last_number + 1`                                             |
| `{YEAR:B.E.}`  | ‡∏õ‡∏µ ‡∏û.‡∏®.                       | `2568`                         | `reset_scope` + 543                                                                             |
| `{YEAR:A.D.}`  | ‡∏õ‡∏µ ‡∏Ñ.‡∏®.                       | `2025`                         | `reset_scope`                                                                                   |
| `{REV}`        | Revision Code                | `A`, `B`, `AA`                 | `correspondence_revisions.revision_label`                                                       |
| `{PREFIX}`     | ‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£         | `COR`, `RFA`                   | Configurable prefix                                                                             |
| `{YYYY}`       | ‡∏õ‡∏µ 4 ‡∏´‡∏•‡∏±‡∏Å                      | `2025`                         | Current year                                                                                    |
| `{YY}`         | ‡∏õ‡∏µ 2 ‡∏´‡∏•‡∏±‡∏Å                      | `25`                           | Current year (short)                                                                            |
| `{MM}`         | ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 2 ‡∏´‡∏•‡∏±‡∏Å                   | `01-12`                        | Current month                                                                                   |
| `{CONTRACT}`   | ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡∏ç‡∏ç‡∏≤                      | `C001`                         | `contracts.contract_code`                                                                       |

### Token Usage Notes

**{SEQ:n}**:

- `n` = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (typically 4-6)
- Counter **‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0001** ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞ 1 (0001, 0002, 0003, ...)
- Padding ‡∏î‡πâ‡∏ß‡∏¢ 0 ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
- Reset ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡∏ï‡∏≤‡∏° `reset_scope` ‡πÉ‡∏ô Counter Key)

**{RECIPIENT}**:

- ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ `recipient_type = 'TO'` ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ TO ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å (‡∏ï‡∏≤‡∏° sort order)
- **‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFA** (RFA ‡πÑ‡∏°‡πà‡∏°‡∏µ {RECIPIENT} ‡πÉ‡∏ô template)

**{CORR_TYPE}**:

- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å `correspondence_types.type_code`
- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
- **‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô template**: RFA only
- **‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô counter**: LETTER, TRANSMITTAL, ‡πÅ‡∏•‡∏∞ Other types

**Deprecated Tokens** (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ):

- ~~`{ORG}`~~ ‚Üí ‡πÉ‡∏ä‡πâ `{ORIGINATOR}` ‡∏´‡∏£‡∏∑‡∏≠ `{RECIPIENT}` ‡πÅ‡∏ó‡∏ô
- ~~`{TYPE}`~~ ‚Üí ‡πÉ‡∏ä‡πâ `{CORR_TYPE}`, `{SUB_TYPE}`, ‡∏´‡∏£‡∏∑‡∏≠ `{RFA_TYPE}` ‡πÅ‡∏ó‡∏ô (‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó)
- ~~`{CATEGORY}`~~ ‚Üí ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

---

## 3.11.5 Character & Format Rules (Updated)

### BR-DN-002 (Revised)

* Document number **must be printable UTF‚Äë8**
* Disallowed:
  * Control characters
  * Newlines / tabs
* Allowed:
  * Thai
  * English
  * Numbers
  * `-`, `_`, `.`

### BR-DN-003: Number Format Rules
- Min length: 10 characters
- Max length: 50 characters
- Must include {SEQ:n} token exactly once

---

## 3.11.6 Number State Machine (New)

### States

```text
RESERVED ‚Üí CONFIRMED ‚Üí VOID
           ‚Üò CANCELLED
```

### Rules

* **RESERVED**:
  * TTL 5 minutes
  * Auto-expire ‚Üí CANCELLED
* **CONFIRMED**:
  * Linked to document_id
* **VOID**:
  * Only CONFIRMED numbers
  * Replacement creates new number

---

## 3.11.7 Idempotency (New)

### API Requirement

* All number generation APIs **must** support:

```http
Idempotency-Key: UUID
```

### Behavior

* Same key + same payload ‚Üí return same number
* Prevents double submit / retry duplication

---

## 3.11.8 Drawing Numbering (Clarified)

* Drawing numbering **does not use** this counter table
* Uses **separate counter namespace**:

```text
DRAWING::<project>::<contract>
```

* Prevents collision with correspondence/RFA

---

## 3.11.9 Token Validation Grammar (New)

### EBNF

```ebnf
TEMPLATE     := TOKEN ("-" TOKEN)*
TOKEN        := SIMPLE | PARAM
SIMPLE       := "{PROJECT}" | "{ORIGINATOR}" | "{RECIPIENT}" |
                "{CORR_TYPE}" | "{DISCIPLINE}" | "{RFA_TYPE}" |
                "{REV}" | "{YYYY}" | "{YY}" | "{MM}"
PARAM        := "{SEQ:" DIGIT+ "}"
DIGIT        := "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" | "8" | "9"
```

### Validation Rules

* Must include `{SEQ:n}` exactly once
* Unknown tokens ‚Üí validation error
* Max template length: 50 chars

---

## 3.11.10 Functional Requirements

### 3.11.10.1 Auto Number Generation

#### FR-DN-001: Generate Sequential Number
**Priority**: CRITICAL | **Status**: Required

**Description**:
‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö (sequential) ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô

**Acceptance Criteria**:
- ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô unique ‡πÉ‡∏ôscope ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡∏•‡∏∞ 1 (increment by 1)
- ‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö concurrent requests ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥
- Response time < 100ms (p95)

---

#### FR-DN-002: Configurable Number Format
**Priority**: HIGH | **Status**: Required

**Description**:
‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢

**Acceptance Criteria**:
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö format tokens ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
- Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î format ‡∏ú‡πà‡∏≤‡∏ô UI ‡πÑ‡∏î‡πâ
- Validate format ‡∏Å‡πà‡∏≠‡∏ô save
- ‡πÅ‡∏™‡∏î‡∏á preview ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á

---

#### FR-DN-003: Scope-based Sequences
**Priority**: HIGH | **Status**: Required

**Description**:
‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á sequence ‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° scope ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô

**Acceptance Criteria**:
- ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô scope ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
- Scope ‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
- Support multiple active scopes

---

### 3.11.10.2 Manual Override

#### FR-DN-004: Manual Number Assignment
**Priority**: HIGH | **Status**: Required

**Description**:
‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (manual override)

**Use Cases**:
1. Import ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
2. External documents ‡∏à‡∏≤‡∏Å client/consultant
3. Correction ‡∏´‡∏•‡∏±‡∏á‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î

**Acceptance Criteria**:
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö duplicate ‡∏Å‡πà‡∏≠‡∏ô save
- Validate format ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- Auto-update sequence counter ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ current
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å audit log ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô manual override
- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Admin ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

---

#### FR-DN-005: Bulk Import Support
**Priority**: MEDIUM | **Status**: Required

**Description**:
‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ import ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

**Acceptance Criteria**:
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV/Excel
- Validate ‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô import
- ‡πÅ‡∏™‡∏î‡∏á preview ‡∏Å‡πà‡∏≠‡∏ô confirm
- Rollback ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏î‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (transactional)
- Auto-update sequence counters ‡∏´‡∏•‡∏±‡∏á import
- Generate import report

---

### 3.11.10.3 Cancelled & Void Handling

#### FR-DN-006: Skip Cancelled Numbers
**Priority**: HIGH | **Status**: Required

**Description**:
‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å reuse

**Rationale**:
- ‡∏£‡∏±‡∏Å‡∏©‡∏≤ audit trail ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏ö‡∏™‡∏ô
- Legal compliance

**Acceptance Criteria**:
- Cancelled number ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏° status
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡πâ‡∏≤‡∏° (skip) cancelled number ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
- ‡πÅ‡∏™‡∏î‡∏á cancelled numbers ‡πÉ‡∏ô audit trail

---

#### FR-DN-007: Void and Replace
**Priority**: HIGH | **Status**: Required

**Description**:
‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ void ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ó‡∏ô

**Workflow**:
1. User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ void
2. ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (required)
3. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô status ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô VOID
4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
5. Link ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏¥‡∏° (voided_from_id)

**Acceptance Criteria**:
- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏° status = VOID (‡πÑ‡∏°‡πà‡∏•‡∏ö)
- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å sequence
- ‡∏°‡∏µ reference link ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å void reason
- ‡πÅ‡∏™‡∏î‡∏á void history chain (A‚ÜíB‚ÜíC)

---

### 3.11.10.4 Concurrency & Performance

#### FR-DN-008: Prevent Race Conditions
**Priority**: CRITICAL | **Status**: Required

**Description**:
‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£ request ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô

**Solution**:
- Distributed locking (Redlock)
- Database pessimistic locking
- Two-phase commit pattern

**Acceptance Criteria**:
- Zero duplicate numbers ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ concurrent load (1000 req/s)
- Lock acquisition time < 50ms (avg)
- Automatic retry on lock failure (max 3 times)
- Timeout handling (30 seconds)

---

#### FR-DN-009: Two-Phase Commit
**Priority**: HIGH | **Status**: Required

**Description**:
‡πÉ‡∏ä‡πâ Two-phase commit pattern ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

**Phase 1: Reserve**
- ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞ reserve ‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
- Set TTL 5 ‡∏ô‡∏≤‡∏ó‡∏µ
- Return reservation token

**Phase2: Confirm or Cancel**
- Confirm: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏≤‡∏ß‡∏£
- Cancel: ‡∏Ñ‡∏∑‡∏ô lock ‡πÅ‡∏•‡∏∞ reservation

**Acceptance Criteria**:
- Reservation ‡∏ï‡πâ‡∏≠‡∏á expire ‡∏´‡∏•‡∏±‡∏á 5 ‡∏ô‡∏≤‡∏ó‡∏µ
- Auto-cleanup expired reservations
- Support explicit cancel
- Idempotent confirmation

---
### 3.11.10.5 Monitoring & Audit

#### FR-DN-010: Complete Audit Trail
**Priority**: HIGH | **Status**: Required

**Description**:
‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å operation ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£

**Events to Log**:
- Number reserved
- Number confirmed
- Number cancelled
- Manual override
- Void document
- Sequence adjusted
- Format changed

**Acceptance Criteria**:
- Log ‡∏ó‡∏∏‡∏Å operation
- Searchable by user, date, type
- Export to CSV
- Retain for 7 years

---

#### FR-DN-011: Metrics & Alerting
**Priority**: MEDIUM | **Status**: Required

**Description**:
‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á alert ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤

**Metrics**:
- Sequence utilization (% of max)
- Average lock wait time
- Failed lock attempts
- Numbers generated per day
- Manual overrides per day

**Alerts**:
- Sequence >90% used (WARNING)
- Sequence >95% used (CRITICAL)
- Lock wait time >1s (WARNING)
- Redis unavailable (CRITICAL)
- High error rate (WARNING)

---

## 3.11.11 Database Schema (Corrected)

### 3.11.11.1 document_number_counters

```sql
CREATE TABLE document_number_counters (
  project_id INT NOT NULL,
  originator_organization_id INT NOT NULL,
  recipient_organization_id INT NOT NULL DEFAULT 0, -- 0 = no recipient (RFA)
  correspondence_type_id INT NOT NULL,
  sub_type_id INT DEFAULT 0,
  rfa_type_id INT DEFAULT 0,
  discipline_id INT DEFAULT 0,
  reset_scope VARCHAR(20) NOT NULL,
  last_number INT DEFAULT 0 NOT NULL,
  version INT DEFAULT 0 NOT NULL,

  PRIMARY KEY (
    project_id,
    originator_organization_id,
    recipient_organization_id,
    correspondence_type_id,
    sub_type_id,
    rfa_type_id,
    discipline_id,
    reset_scope
  ),

  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  FOREIGN KEY (originator_organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
  FOREIGN KEY (recipient_organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
  FOREIGN KEY (correspondence_type_id) REFERENCES correspondence_types(id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_general_ci
  COMMENT = '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö Running Number Counters';
```

### Rules

* RFA ‚Üí `recipient_organization_id = 0`
* Reset:
  * Yearly: `reset_scope = 'YEAR_2025'`
  * No reset: `reset_scope = 'NONE'`

### 3.11.11.2 Index Requirements

```sql
-- Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Performance
CREATE INDEX idx_counter_lookup
ON document_number_counters (
  project_id,
  correspondence_type_id,
  reset_scope
);

-- Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Originator lookup
CREATE INDEX idx_counter_org
ON document_number_counters (
  originator_organization_id,
  reset_scope
);
```

### 3.11.11.3 Numbering Configuration Table

```sql
CREATE TABLE document_numbering_configs (
  id INT PRIMARY KEY AUTO_INCREMENT,
  document_type VARCHAR(50) NOT NULL,
  format VARCHAR(200) NOT NULL,
  scope ENUM('GLOBAL','PROJECT','CONTRACT','YEARLY','MONTHLY'),
  allow_manual_override BOOLEAN DEFAULT FALSE,
  max_value INT DEFAULT 999999,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY (document_type, scope)
);
```

### 3.11.11.4 Audit Log Table

```sql
CREATE TABLE document_number_audit (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  document_id INT NOT NULL,
  generated_number VARCHAR(100) NOT NULL,
  counter_key JSON NOT NULL COMMENT 'Counter key used (JSON format)',
  template_used VARCHAR(200) NOT NULL,
  user_id INT NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- Performance & Error Tracking
  retry_count INT DEFAULT 0,
  lock_wait_ms INT COMMENT 'Lock acquisition time in milliseconds',
  total_duration_ms INT COMMENT 'Total generation time',
  fallback_used ENUM('NONE', 'DB_LOCK', 'RETRY') DEFAULT 'NONE',

  INDEX idx_document_id (document_id),
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id)
) ENGINE=InnoDB COMMENT='Document Number Generation Audit Trail';
```

### 3.11.11.5 Error Log Table

```sql
CREATE TABLE document_number_errors (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  error_type ENUM(
    'LOCK_TIMEOUT',
    'VERSION_CONFLICT',
    'DB_ERROR',
    'REDIS_ERROR',
    'VALIDATION_ERROR'
  ) NOT NULL,
  error_message TEXT,
  stack_trace TEXT,
  context_data JSON COMMENT 'Request context (user, project, etc.)',
  user_id INT,
  ip_address VARCHAR(45),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  resolved_at TIMESTAMP NULL,

  INDEX idx_error_type (error_type),
  INDEX idx_created_at (created_at),
  INDEX idx_user_id (user_id)
) ENGINE=InnoDB COMMENT='Document Numbering Error Log';
```

### 3.11.11.6 Config History Table

```sql
CREATE TABLE document_number_config_history (
  id INT AUTO_INCREMENT PRIMARY KEY,
  config_id INT NOT NULL,
  template_before TEXT,
  template_after TEXT NOT NULL,
  changed_by INT NOT NULL,
  changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  change_reason TEXT,

  FOREIGN KEY (config_id) REFERENCES document_number_configs(id),
  FOREIGN KEY (changed_by) REFERENCES users(id)
) ENGINE=InnoDB COMMENT='Template Change History';
```

### 3.11.11.7 Important Notes

> **üí° Counter Key Design**
> - `recipient_organization_id` ‡πÉ‡∏ä‡πâ `0` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFA (‡πÑ‡∏°‡πà‡∏°‡∏µ specific recipient)
> - `version` column ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Optimistic Locking (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition)
> - `last_number` ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0 ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡∏•‡∏∞ 1
> - Counter reset ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡πÄ‡∏°‡∏∑‡πà‡∏≠ `reset_scope` ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)

> **‚ö†Ô∏è Migration Notes**
> - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ backward compatibility
> - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á table ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ï‡∏≤‡∏° schema ‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô
> - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ seed data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö `correspondence_types`, `rfa_types`, `disciplines` ‡∏Å‡πà‡∏≠‡∏ô

### 3.11.11.8 Example Counter Records

```sql
-- Example: LETTER from ‡∏Ñ‡∏Ñ‡∏á. to ‡∏™‡∏Ñ‡∏â.3 in LCBP3-C2 year 2025
INSERT INTO document_number_counters (
  project_id, originator_organization_id, recipient_organization_id,
  correspondence_type_id, sub_type_id, rfa_type_id, discipline_id,
  reset_scope, version, last_number
) VALUES (
  2,      -- LCBP3-C2
  22,     -- ‡∏Ñ‡∏Ñ‡∏á.
  10,     -- ‡∏™‡∏Ñ‡∏â.3
  6,      -- LETTER
  0, 0, 0,
  'YEAR_2025', 0, 0
);

-- Example: RFA from ‡∏ú‡∏£‡∏°.2 in LCBP3-C2, discipline TER, type RPT, year 2025
INSERT INTO document_number_counters (
  project_id, originator_organization_id, recipient_organization_id,
  correspondence_type_id, sub_type_id, rfa_type_id, discipline_id,
  reset_scope, version, last_number
) VALUES (
  2,      -- LCBP3-C2
  42,     -- ‡∏ú‡∏£‡∏°.2
  0,      -- RFA ‡πÑ‡∏°‡πà‡∏°‡∏µ specific recipient
  1,      -- RFA
  0,
  18,     -- RPT (Report)
  5,      -- TER (Terminal)
  'NONE', 0, 0  -- No yearly reset for RFA
);
```

---

## 3.11.12 Security & Data Integrity Requirements

### 3.11.12.1 Concurrency Control

**Requirements:**

- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô uniqueness ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏Ñ‡∏ß‡∏£**‡πÉ‡∏ä‡πâ Distributed Lock (Redis) ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πÑ‡∏Å primary
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏°‡∏µ fallback mechanism ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Redis ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

### 3.11.12.2 Data Integrity

**Requirements:**

- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡πÉ‡∏ä‡πâ Optimistic Locking ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö concurrent updates
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏°‡∏µ database constraints ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:
  - Unique constraint ‡∏ö‡∏ô `document_number`
  - Foreign key constraints ‡∏ó‡∏∏‡∏Å relationship
  - Check constraints ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö business rules

### 3.11.12.3 Authorization

**Requirements:**

- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **authenticated users** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ request document number
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **Project Admin** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡πÑ‡∏î‡πâ
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **Super Admin** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà reset counter ‡πÑ‡∏î‡πâ (requires approval)

### 3.11.12.4 Rate Limiting

**Requirements:**
- Limit ‡∏ï‡πà‡∏≠ user: **10 requests/minute** (prevent abuse)
- Limit ‡∏ï‡πà‡∏≠ IP: **50 requests/minute**

---

## 3.11.13 Error Handling Requirements

### 3.11.13.1 Retry Mechanism

**Requirements:**

‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error scenarios ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

| Scenario            | Strategy            | Max Retries | Expected Response               |
| ------------------- | ------------------- | ----------- | ------------------------------- |
| Redis Unavailable   | Fallback to DB Lock | 0           | Continue (degraded performance) |
| Lock Timeout        | Exponential Backoff | 5           | HTTP 503 after final retry      |
| Version Conflict    | Immediate Retry     | 2           | HTTP 409 after final retry      |
| DB Connection Error | Exponential Backoff | 3           | HTTP 500 after final retry      |

### 3.11.13.2 User Experience

**Requirements:**

- Error messages **‡∏ï‡πâ‡∏≠‡∏á**‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
- HTTP status codes **‡∏ï‡πâ‡∏≠‡∏á**‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
- Frontend **‡∏Ñ‡∏ß‡∏£**‡πÅ‡∏™‡∏î‡∏á retry option ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö transient errors

---

## 3.11.14 Configuration Management Requirements

### 3.11.14.1 Template Management

**Requirements:**

- Project Admin **‡∏ï‡πâ‡∏≠‡∏á**‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡∏ú‡πà‡∏≤‡∏ô Admin Panel
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**validate template ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á template **‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà**‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß

### 3.11.14.2 Template Versioning

**Requirements:**

- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡πÄ‡∏Å‡πá‡∏ö history ‡∏Ç‡∏≠‡∏á template changes
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å user, timestamp, ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏Ñ‡∏ß‡∏£**‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ rollback ‡πÑ‡∏õ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ

### 3.11.14.3 Counter Reset Policy

**Requirements:**

- Counter **‡∏ï‡πâ‡∏≠‡∏á**reset ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
- Admin **‡∏ï‡πâ‡∏≠‡∏á**‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ manual reset counter ‡πÑ‡∏î‡πâ (require approval + audit log)

---

## 3.11.15 Audit Trail Requirements

### 3.11.15.1 Audit Logging

**Requirements:**

‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å document number generation:

- `document_id` - ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
- `generated_number` - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
- `counter_key` - key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö (JSON format)
- `template_used` - template ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
- `user_id` - ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà request
- `ip_address` - IP address ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ request
- `timestamp` - ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
- `retry_count` - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà retry
- `performance_metrics` - Lock wait time, total duration

### 3.11.15.2 Error Logging

**Requirements:**

- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å error ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏° error type classification
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏Ñ‡∏ß‡∏£**alert ops team ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö critical errors

### 3.11.15.3 Retention Policy

**Requirements:**

- Audit log **‡∏ï‡πâ‡∏≠‡∏á**‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **7 ‡∏õ‡∏µ** (‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå)

---

## 3.11.16 Performance Requirements

### 3.11.16.1 Response Time

**SLA Targets:**

| Metric            | Target   | Notes                    |
| ----------------- | -------- | ------------------------ |
| 95th percentile   | ‚â§ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà request ‡∏ñ‡∏∂‡∏á response |
| 99th percentile   | ‚â§ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏£‡∏ß‡∏° retry attempts       |
| Normal operation  | ‚â§ 500ms  | ‡πÑ‡∏°‡πà‡∏°‡∏µ retry                |
| Number generation | < 100ms  | (p95)                    |
| Lock acquisition  | < 50ms   | (avg)                    |
| Bulk import       | < 5s     | per 100 records          |

### 3.11.16.2 Throughput

**Capacity Targets:**

| Load Level  | Target      | Notes              |
| ----------- | ----------- | ------------------ |
| Normal load | ‚â• 50 req/s  | ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥           |
| Peak load   | ‚â• 100 req/s | ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏á‡∏á‡∏≤‡∏ô          |
| Burst       | ‚â• 200 req/s | short duration     |
| Support     | > 500 req/s | Scale horizontally |

### 3.11.16.3 Availability

**SLA Targets:**

- **Uptime**: ‚â• 99.5% (excluding planned maintenance)
- **Maximum downtime**: ‚â§ 3.6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- **RTO**: ‚â§ 30 ‡∏ô‡∏≤‡∏ó‡∏µ
- **RPO**: ‚â§ 5 ‡∏ô‡∏≤‡∏ó‡∏µ
- **Graceful degradation**: Fallback to DB-only
- **Auto-recovery**: From Redis failure

---

## 3.11.17 Monitoring & Alerting Requirements

### 3.11.17.1 Metrics

**Requirements:**

‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**collect metrics ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

- Lock acquisition time (p50, p95, p99)
- Lock acquisition success/failure rate
- Counter generation latency
- Retry count distribution
- Redis connection status
- Database connection pool usage
- Sequence utilization (% of max)
- Numbers generated per day
- Manual overrides per day

### 3.11.17.2 Alerts

**Requirements:**

‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**alert ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö conditions ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

| Severity   | Condition                    | Action            |
| ---------- | ---------------------------- | ----------------- |
| üî¥ Critical | Redis unavailable > 1 minute | PagerDuty + Slack |
| üî¥ Critical | Lock failures > 10% in 5 min | PagerDuty + Slack |
| üî¥ Critical | Sequence >95% used           | PagerDuty + Slack |
| üü° Warning  | Lock failures > 5% in 5 min  | Slack             |
| üü° Warning  | Avg lock wait time > 1 sec   | Slack             |
| üü° Warning  | Retry count > 100/hour       | Slack             |
| üü° Warning  | Sequence >90% used           | Slack             |
| üü° Warning  | High error rate              | Slack             |

### 3.11.17.3 Dashboard

**Requirements:**

- Ops team **‡∏ï‡πâ‡∏≠‡∏á**‡∏°‡∏µ real-time dashboard (Grafana) ‡πÅ‡∏™‡∏î‡∏á:
  - Lock acquisition success rate
  - Lock wait time percentiles
  - Generation rate (per minute)
  - Error rate by type
  - Connection health status
  - Retry distribution

---

## 3.11.18 API Reference

### Document Number Generation

```http
POST /api/v1/documents/{documentId}/generate-number
```

‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö document ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏

**Request Body:**

```json
{
  "counterKey": {
    "projectId": 2,
    "originatorOrgId": 22,
    "recipientOrgId": 10,
    "correspondenceTypeId": 6,
    "subTypeId": 0,
    "rfaTypeId": 0,
    "disciplineId": 0,
    "resetScope": "YEAR_2025"
  }
}
```

**Response:**

```json
{
  "documentNumber": "‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-0001-2568",
  "generatedAt": "2025-12-02T15:30:00Z"
}
```

### Reserve Number

```http
POST /api/document-numbering/reserve
```

**Request:**
```json
{
  "document_type": "COR",
  "project_id": 1,
  "contract_id": null,
  "metadata": {}
}
```

**Response 201:**
```json
{
  "token": "uuid-v4",
  "document_number": "COR-2025-00042",
  "expires_at": "2025-01-16T10:30:00Z"
}
```

### Confirm Reservation

```http
POST /api/document-numbering/confirm
```

**Request:**
```json
{
  "token": "uuid-v4"
}
```

**Response 200:**
```json
{
  "document_number": "COR-2025-00042",
  "confirmed_at": "2025-01-16T10:25:00Z"
}
```

### Manual Override

```http
POST /api/document-numbering/manual
Authorization: Bearer <admin-token>
```

**Request:**
```json
{
  "document_type": "COR",
  "document_number": "COR-2024-99999",
  "reason": "Import from legacy system",
  "skip_validation": false
}
```

**Response 201:**
```json
{
  "document_number": "COR-2024-99999",
  "is_manual": true,
  "created_at": "2025-01-16T10:25:00Z"
}
```

### Template Management

```http
GET /api/v1/document-numbering/configs
```

‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ template configuration ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

```http
PUT /api/v1/document-numbering/configs/{configId}
```

‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template (Project Admin only)

```http
POST /api/v1/document-numbering/configs/{configId}/reset-counter
```

Reset counter (Super Admin only, requires approval)

---

## 3.11.19 Testing Requirements

### 3.11.19.1 Unit Tests
- Format parsing and validation
- Sequence increment logic
- Manual override validation
- Scope resolution

### 3.11.19.2 Integration Tests
- Redis locking mechanism
- Database transactions
- Two-phase commit flow
- Bulk import

### 3.11.19.3 Load Tests

```bash
# Must pass without duplicates
concurrent_users: 100
requests_per_second: 500
test_duration: 5 minutes
expected_duplicates: 0
```

- Concurrent number generation (1000 req/s)
- Lock contention under load
- Redis failover scenarios
- Database connection pool exhaustion

### 3.11.19.4 E2E Tests
- Complete document creation flow
- Void and replace workflow
- Bulk import with validation
- Admin configuration UI

---

## 3.11.20 Versioning Note

* Existing documents **not affected**
* New rules apply to documents generated after upgrade to v1.6.2

---

## 3.11.21 Migration Plan

### 3.11.21.1 Legacy Data Import
1. Export existing document numbers from old system
2. Validate format and detect duplicates
3. Bulk import using manual override API
4. Update sequence counters to max values
5. Verify data integrity

### 3.11.21.2 Rollout Strategy
- Week 1-2: Deploy to staging, test with dummy data
- Week 3: Deploy to production, enable for test project
- Week 4: Enable for all projects
- Week 5+: Monitor and optimize

---

## 3.11.22 Success Criteria

### 3.11.22.1 Functional Success
- ‚úÖ All FRs implemented and tested
- ‚úÖ Zero duplicate numbers in production
- ‚úÖ Migration of 50,000+ legacy documents
- ‚úÖ UAT approved by stakeholders

### 3.11.22.2 Performance Success
- ‚úÖ Response time <100ms (p95)
- ‚úÖ Throughput >500 req/s
- ‚úÖ Lock acquisition <50ms (avg)
- ‚úÖ Zero downtime during deployment

### 3.11.22.3 Business Success
- ‚úÖ Document creation speed +30%
- ‚úÖ Manual numbering errors -80%
- ‚úÖ User satisfaction >4.5/5
- ‚úÖ System stability >99.9%

---

## 3.11.23 References

- [Implementation Guide](file:///d:/nap-dms.lcbp3/specs/03-implementation/document-numbering.md)
- [Operations Guide](file:///d:/nap-dms.lcbp3/specs/04-operations/document-numbering-operations.md)
- [API Design](file:///d:/nap-dms.lcbp3/specs/02-architecture/api-design.md)
- [Data Dictionary](file:///d:/nap-dms.lcbp3/specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md)
- [ADR-018: Document Numbering Strategy](file:///d:/nap-dms.lcbp3/specs/05-decisions/adr-018-document-numbering.md)
- [Two-Phase Commit Pattern](https://en.wikipedia.org/wiki/Two-phase_commit_protocol)
- [Redlock Algorithm](https://redis.io/docs/manual/patterns/distributed-locks/)

---

## 3.11.24 Appendix

### 3.11.24.1 Glossary
- **Sequence**: ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
- **Scope**: ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏ó‡∏µ‡πà sequence ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° (project, contract, etc.)
- **Token**: Format placeholder (e.g., {YYYY}, {SEQ})
- **Redlock**: Distributed locking algorithm ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Redis

---

**Approval Sign-off**:

| Role          | Name        | Date    | Signature |
| ------------- | ----------- | ------- | --------- |
| Product Owner | ___________ | _______ | _________ |
| Tech Lead     | ___________ | _______ | _________ |
| QA Lead       | ___________ | _______ | _________ |

**End of Document v1.6.2**
