# 3.11 Document Numbering Management (‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)

---
title: 'Functional Requirements: Document Numbering Management'
version: 1.6.0
status: draft
owner: Nattanin Peancharoen
last_updated: 2025-12-02
related:
  - specs/01-requirements/01-objectives.md
  - specs/01-requirements/02-architecture.md
  - specs/01-requirements/03-functional-requirements.md
  - specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md
---

## 3.11.1. ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå

- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Running Number) ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (template) ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô Uniqueness ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö concurrent ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

## 3.11.2. Logic ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç (Counter Logic)

‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° **Counter Key** ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£

### Counter Key Components

| Component | Required? | Description | Database Source | Default if NULL |
|-----------|-----------|-------------|-----------------|-----------------|
| `project_id` | ‚úÖ Yes | ID ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ | Derived from user context or organization | - |
| `originator_organization_id` | ‚úÖ Yes | ID ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á | `correspondences.originator_id` | - |
| `recipient_organization_id` | Depends on type | ID ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO) | `correspondence_recipients` where `recipient_type = 'TO'` | NULL for RFA |
| `correspondence_type_id` | ‚úÖ Yes | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ | `correspondence_types.id` | - |
| `sub_type_id` | TRANSMITTAL only | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ | `correspondence_sub_types.id` | 0 |
| `rfa_type_id` | RFA only | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA | `rfa_types.id` | 0 |
| `discipline_id` | RFA only | ID ‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô | `disciplines.id` | 0 |
| `current_year` | ‚úÖ Yes | ‡∏õ‡∏µ ‡∏Ñ.‡∏®. | System year (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô) | - |

### Counter Key ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£

**LETTER / RFI / MEMO / EMAIL / MOM / INSTRUCTION / NOTICE / OTHER**:
```
(project_id, originator_organization_id, recipient_organization_id,
 correspondence_type_id, 0, 0, 0, current_year)
```
*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏*: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ `discipline_id`, `sub_type_id`, `rfa_type_id`

**TRANSMITTAL**:
```
(project_id, originator_organization_id, recipient_organization_id,
 correspondence_type_id, sub_type_id, 0, 0, current_year)
```
*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏*: ‡πÉ‡∏ä‡πâ `sub_type_id` ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

**RFA**:
```
(project_id, originator_organization_id, NULL,
 correspondence_type_id, 0, rfa_type_id, discipline_id, current_year)
```
*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏*: RFA ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ `recipient_organization_id` ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (CONTRACTOR ‚Üí CONSULTANT ‚Üí OWNER)

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏≤ project_id

‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Template ‡∏Ç‡∏≠‡∏á LETTER/TRANSMITTAL ‡πÑ‡∏°‡πà‡∏°‡∏µ `{PROJECT}` token ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤ `project_id` ‡∏à‡∏≤‡∏Å:

1. **User Context** (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥):
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠ User ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ UI ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Project/Contract ‡∏Å‡πà‡∏≠‡∏ô
   - ‡πÉ‡∏ä‡πâ `project_id` ‡∏à‡∏≤‡∏Å Context ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

2. **‡∏à‡∏≤‡∏Å Organization**:
   - Query `project_organizations` ‡∏´‡∏£‡∏∑‡∏≠ `contract_organizations`
   - ‡πÉ‡∏ä‡πâ `originator_organization_id` ‡∏´‡∏≤ project ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
   - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ project ‡πÉ‡∏´‡πâ User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

3. **Validation**:
   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ organization ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô project ‡∏ô‡∏±‡πâ‡∏ô
   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ project/contract ‡πÄ‡∏õ‡πá‡∏ô active

### Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ NULL

- `discipline_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô)
- `sub_type_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢)
- `rfa_type_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA)
- `recipient_organization_id`: ‡πÉ‡∏ä‡πâ `NULL` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFA, Required ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LETTER/TRANSMITTAL


## 3.11.3. Format Templates by Correspondence Type

> **üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**
> - Templates ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å
> - ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö **‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£** ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô `correspondence_types` table
> - ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
> - Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Template ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡πà‡∏≤‡∏ô Admin Panel

### 3.11.3.1. Letter (TYPE = LETTER)

**Template**:
```
{ORIGINATOR}-{RECIPIENT}-{SEQ:4}-{YEAR:B.E.}
```

**Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-0001-2568`

**Token Breakdown**:
- `‡∏Ñ‡∏Ñ‡∏á.` = {ORIGINATOR} = ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á
- `‡∏™‡∏Ñ‡∏â.3` = {RECIPIENT} = ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO)
- `0001` = {SEQ:4} = Running number (‡πÄ‡∏£‡∏¥‡πà‡∏° 0001, 0002, ...)
- `2568` = {YEAR:B.E.} = ‡∏õ‡∏µ ‡∏û.‡∏®.

> **‚ö†Ô∏è Template vs Counter Separation**
> - {CORR_TYPE} **‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á**‡πÉ‡∏ô template ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
> - ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö**‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ correspondence_type_id ‡πÉ‡∏ô Counter Key** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å counter
> - LETTER, MEMO, RFI **‡∏°‡∏µ counter ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô** ‡πÅ‡∏°‡πâ template format ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

**Counter Key**: `(project_id, originator_org_id, recipient_org_id, corr_type_id, 0, 0, 0, year)`

---

### 3.11.3.2. Transmittal (TYPE = TRANSMITTAL)

**Template**:
```
{ORIGINATOR}-{RECIPIENT}-{SUB_TYPE}-{SEQ:4}-{YEAR:B.E.}
```

**Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-21-0117-2568`

**Token Breakdown**:
- `‡∏Ñ‡∏Ñ‡∏á.` = {ORIGINATOR}
- `‡∏™‡∏Ñ‡∏â.3` = {RECIPIENT}
- `21` = {SUB_TYPE} = ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ (11=MAT, 12=SHP, 13=DWG, 14=MET, ...)
- `0117` = {SEQ:4}
- `2568` = {YEAR:B.E.}

> **‚ö†Ô∏è Template vs Counter Separation**
> - {CORR_TYPE} **‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á**‡πÉ‡∏ô template (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô LETTER)
> - TRANSMITTAL ‡∏°‡∏µ counter ‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å LETTER

**Counter Key**: `(project_id, originator_org_id, recipient_org_id, corr_type_id, sub_type_id, 0, 0, year)`

---

### 3.11.3.3. RFA (Request for Approval)

**Template**:
```
{PROJECT}-{CORR_TYPE}-{DISCIPLINE}-{RFA_TYPE}-{SEQ:4}-{REV}
```

**Example**: `LCBP3-C2-RFA-TER-RPT-0001-A`

**Token Breakdown**:
- `LCBP3-C2` = {PROJECT} = ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
- `RFA` = {CORR_TYPE} = ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (**‡πÅ‡∏™‡∏î‡∏á**‡πÉ‡∏ô RFA template)
- `TER` = {DISCIPLINE} = ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô (TER=Terminal, STR=Structure, ...)
- `RPT` = {RFA_TYPE} = ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA (RPT=Report, SDW=Shop Drawing, ...)
- `0001` = {SEQ:4}
- `A` = {REV} = Revision code

> **üìã RFA Workflow**
> - RFA ‡πÄ‡∏õ‡πá‡∏ô **‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£** (Project-level document)
> - Workflow: **CONTRACTOR ‚Üí CONSULTANT ‚Üí OWNER**
> - ‡πÑ‡∏°‡πà‡∏°‡∏µ specific `recipient_id` ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô workflow ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß

**Counter Key**: `(project_id, originator_org_id, NULL, corr_type_id, 0, rfa_type_id, discipline_id, year)`

---

### 3.11.3.4. Drawing

**Status**: üöß **To Be Determined**

Drawing Numbering ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Template ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å:
- ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏™‡∏π‡∏á (Contract Drawing ‡πÅ‡∏•‡∏∞ Shop Drawing ‡∏°‡∏µ‡∏Å‡∏é‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)
- ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Numbering ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
- ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö RFA ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

---

### 3.11.3.5. Other Correspondence Types

**Applicable to**: RFI, MEMO, EMAIL, MOM, INSTRUCTION, NOTICE, OTHER

**Template**:
```
{ORIGINATOR}-{RECIPIENT}-{SEQ:4}-{YEAR:B.E.}
```

**Example (RFI)**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-0042-2568`
**Example (MEMO)**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏ú‡∏£‡∏°.1-0001-2568`

> **üîë Counter Separation**
> - ‡πÅ‡∏°‡πâ template format **‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö LETTER**
> - ‡πÅ‡∏ï‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞ type ‡∏°‡∏µ **counter ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô** ‡∏ú‡πà‡∏≤‡∏ô `correspondence_type_id`
> - RFI counter ‚â† MEMO counter ‚â† LETTER counter

**Counter Key**: `(project_id, originator_org_id, recipient_org_id, corr_type_id, 0, 0, 0, year)`

**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏**: ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∞‡πÉ‡∏ä‡πâ Template ‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° correspondence type ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô `correspondence_types` table ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Template ‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥


## 3.11.4. Supported Token Types

| Token | Description | Example | Database Source |
|-------|-------------|---------|-----------------|
| `{PROJECT}` | ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ | `LCBP3`, `LCBP3-C2` | `projects.project_code` |
| `{ORIGINATOR}` | ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á | `‡∏Ñ‡∏Ñ‡∏á.`, `‡∏ú‡∏£‡∏°.1` | `organizations.organization_code` via `correspondences.originator_id` |
| `{RECIPIENT}` | ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO) | `‡∏™‡∏Ñ‡∏â.3`, `‡∏Å‡∏ó‡∏ó.` | `organizations.organization_code` via `correspondence_recipients` where `recipient_type = 'TO'` |
| `{CORR_TYPE}` | ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ | `RFA`, `TRANSMITTAL`, `LETTER` | `correspondence_types.type_code` |
| `{SUB_TYPE}` | ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ | `11`, `12`, `21` | `correspondence_sub_types.sub_type_number` |
| `{RFA_TYPE}` | ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA | `SDW`, `RPT`, `MAT` | `rfa_types.type_code` |
| `{DISCIPLINE}` | ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ | `STR`, `TER`, `GEO` | `disciplines.discipline_code` |
| `{SEQ:n}` | Running number (n = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å) | `0001`, `0029`, `0985` | Based on `document_number_counters.last_number + 1` |
| `{YEAR:B.E.}` | ‡∏õ‡∏µ ‡∏û.‡∏®. | `2568` | `document_number_counters.current_year + 543` |
| `{YEAR:A.D.}` | ‡∏õ‡∏µ ‡∏Ñ.‡∏®. | `2025` | `document_number_counters.current_year` |
| `{REV}` | Revision Code | `A`, `B`, `AA` | `correspondence_revisions.revision_label` |

### Token Usage Notes

**{SEQ:n}**:
- `n` = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (typically 4)
- Counter **‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0001** ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞ 1 (0001, 0002, 0003, ...)
- Padding ‡∏î‡πâ‡∏ß‡∏¢ 0 ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
- Reset ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡∏ï‡∏≤‡∏° `current_year` ‡πÉ‡∏ô Counter Key)

**{RECIPIENT}**:
- ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ `recipient_type = 'TO'` ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ TO ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å (‡∏ï‡∏≤‡∏° sort order)
- **‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFA** (RFA ‡πÑ‡∏°‡πà‡∏°‡∏µ {RECIPIENT} ‡πÉ‡∏ô template)

**{CORR_TYPE}**:
- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å `correspondence_types.type_code`
- ‡∏ñ‡πâ‡∏≤‡∏°ÔøΩ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
- **‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô template**: RFA only
- **‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô counter**: LETTER, TRANSMITTAL, ‡πÅ‡∏•‡∏∞ Other types

**Deprecated Tokens** (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ):
- ~~`{ORG}`~~ ‚Üí ‡πÉ‡∏ä‡πâ `{ORIGINATOR}` ‡∏´‡∏£‡∏∑‡∏≠ `{RECIPIENT}` ‡πÅ‡∏ó‡∏ô
- ~~`{TYPE}`~~ ‚Üí ‡πÉ‡∏ä‡πâ `{CORR_TYPE}`, `{SUB_TYPE}`, ‡∏´‡∏£‡∏∑‡∏≠ `{RFA_TYPE}` ‡πÅ‡∏ó‡∏ô (‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó)
- ~~`{CATEGORY}`~~ ‚Üí ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô



## 3.11.5. ‡∏Å‡∏•‡πÑ‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Concurrency Control)

### 3.11.6.1. Redis Distributed Lock

- ‡πÉ‡∏ä‡πâ Redis Distributed Lock ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition
- Lock key format: `lock:docnum:{project_id}:{doc_type_id}:{...counter_key_parts}`
- Lock TTL: 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (auto-release ‡πÄ‡∏°‡∏∑‡πà‡∏≠ timeout)
- Lock acquisition timeout: 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

### 3.11.6.2. Optimistic Locking

- ‡πÉ‡∏ä‡πâ `version` column ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á `document_number_configs`
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö version ‡∏Å‡πà‡∏≠‡∏ô update counter
- ‡∏´‡∏≤‡∏Å version conflict ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí retry transaction

### 3.11.6.3. Database Constraints

- Unique constraint ‡∏ö‡∏ô `document_number` column
- Foreign key constraints ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- Check constraints ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö business rules

## 3.11.7. Retry Mechanism & Error Handling

### 3.11.7.1. Scenario 1: Redis Unavailable

- **Fallback**: ‡πÉ‡∏ä‡πâ database-only locking (pessimistic lock)
- **Action**:
  - ‡πÉ‡∏ä‡πâ `SELECT ... FOR UPDATE` ‡πÅ‡∏ó‡∏ô Redis lock
  - Log warning ‡∏û‡∏£‡πâ‡∏≠‡∏° alert ops team
  - ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà performance ‡∏•‡∏î‡∏•‡∏á

### 3.11.7.2. Scenario 2: Lock Acquisition Timeout

- **Retry**: 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ exponential backoff
  - Attempt 1: wait 1s
  - Attempt 2: wait 2s
  - Attempt 3: wait 4s
  - Attempt 4: wait 8s
  - Attempt 5: wait 16s (‡∏£‡∏ß‡∏° ~31 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
- **Failure**: Return HTTP 503 "Service Temporarily Unavailable"
- **Frontend**: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∏‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á"

### 3.11.7.3. Scenario 3: Version Conflict After Lock

- **Retry**: 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (reload counter + retry transaction)
- **Failure**: Log error ‡∏û‡∏£‡πâ‡∏≠‡∏° context ‡πÅ‡∏•‡∏∞ return HTTP 409 Conflict
- **Frontend**: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"

### 3.11.7.4. Scenario 4: Database Connection Error

- **Retry**: 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ exponential backoff (1s, 2s, 4s)
- **Failure**: Return HTTP 500 "Internal Server Error"
- **Frontend**: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"

## 3.11.8. Configuration Management

### 3.11.8.1. Admin Panel Configuration

- Project Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡∏ú‡πà‡∏≤‡∏ô Admin Panel
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á template ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£ validate template ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)

### 3.11.8.2. Template Versioning

- ‡πÄ‡∏Å‡πá‡∏ö history ‡∏Ç‡∏≠‡∏á template changes
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å user, timestamp, ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ rollback ‡πÑ‡∏õ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ

### 3.11.8.3. Counter Reset Policy

- Counter reset ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ (yearly reset)
- Counter reset ‡∏ï‡∏≤‡∏° project phase (optional)
- Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ manual reset counter ‡πÑ‡∏î‡πâ (require approval + audit log)

## 3.11.9. Audit Trail

### 3.11.9.1. ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Audit Log

‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£ generate ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô `document_number_audit` table:

- `document_id` - ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
- `generated_number` - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
- `counter_key` - key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
- `template_used` - template ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
- `user_id` - ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà request
- `ip_address` - IP address ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ request
- `timestamp` - ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
- `retry_count` - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà retry (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

### 3.11.9.2. Conflict & Error Logging

- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å version conflicts ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏•‡πÑ‡∏Å retry ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å lock timeouts ‡πÅ‡∏•‡∏∞ failure reasons
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å fallback scenarios (‡πÄ‡∏ä‡πà‡∏ô Redis unavailable)

## 3.11.10. Performance Requirements

### 3.11.10.1. Response Time

- Document number generation ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô **2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ** (95th percentile)
- Document number generation ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô **5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ** (99th percentile)
- ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ normal operation (‡πÑ‡∏°‡πà‡∏°‡∏µ retry) ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô **500ms**

### 3.11.10.2. Throughput

- ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö concurrent requests ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **50 requests/second**
- Peak load ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á **100 requests/second** (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡πà‡∏á‡∏á‡∏≤‡∏ô)

### 3.11.10.3. Availability

- Uptime ‚â• 99.5% (exclude planned maintenance)
- Maximum downtime ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚â§ 3.6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

## 3.11.11. Monitoring & Alerting

### 3.11.11.1. Metrics to Monitor

- Lock acquisition time (p50, p95, p99)
- Lock acquisition failure rate
- Counter generation latency
- Retry count distribution
- Redis connection status
- Database connection pool usage

### 3.11.11.2. Alert Conditions

- üî¥ **Critical**: Redis unavailable > 1 minute
- üî¥ **Critical**: Lock acquisition failures > 10% in 5 minutes
- üü° **Warning**: Lock acquisition failures > 5% in 5 minutes
- üü° **Warning**: Average lock wait time > 1 second
- üü° **Warning**: Retry count > 100 per hour

### 3.11.11.3. Dashboard

- Real-time lock acquisition success rate
- Lock wait time percentiles (p50, p95, p99)
- Counter generation rate (per minute)
- Error rate breakdown (by error type)
- Redis/Database health status

## 3.11.12. API Reference

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á API endpoints ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô `specs/02-architecture/api-design.md`):

- `POST /api/v1/documents/{documentId}/generate-number` - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- `GET /api/v1/document-numbering/configs` - ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ template
- `PUT /api/v1/document-numbering/configs/{configId}` - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template (Admin only)
- `POST /api/v1/document-numbering/configs/{configId}/reset-counter` - Reset counter (Admin only)

## 3.11.13. Database Schema Reference

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á tables ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô `specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md`):

- `document_number_configs` - ‡πÄ‡∏Å‡πá‡∏ö template ‡πÅ‡∏•‡∏∞ counter configuration
- `document_number_counters` - ‡πÄ‡∏Å‡πá‡∏ö current counter value
- `document_number_audit` - ‡πÄ‡∏Å‡πá‡∏ö audit trail
- `documents` - ‡πÄ‡∏Å‡πá‡∏ö document number ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á

## 3.11.14. Database Schema Requirements

### 3.11.14.1. Counter Table Schema

‡∏ï‡∏≤‡∏£‡∏≤‡∏á `document_number_counters` ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

```sql
CREATE TABLE document_number_counters (
  project_id INT NOT NULL,
  originator_organization_id INT NOT NULL,
  recipient_organization_id INT NULL,  -- NULL for RFA
  correspondence_type_id INT NOT NULL,
  sub_type_id INT DEFAULT 0,           -- for TRANSMITTAL
  rfa_type_id INT DEFAULT 0,           -- for RFA
  discipline_id INT DEFAULT 0,         -- for RFA
  current_year INT NOT NULL,
  version INT DEFAULT 0 NOT NULL,      -- Optimistic Lock
  last_number INT DEFAULT 0,

  PRIMARY KEY (
    project_id,
    originator_organization_id,
    COALESCE(recipient_organization_id, 0),
    correspondence_type_id,
    sub_type_id,
    rfa_type_id,
    discipline_id,
    current_year
  ),

  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  FOREIGN KEY (originator_organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
  FOREIGN KEY (recipient_organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
  FOREIGN KEY (correspondence_type_id) REFERENCES correspondence_types(id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_general_ci
  COMMENT = '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö Running Number Counters';
```

### 3.11.14.2. Index Requirements

```sql
-- Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Performance
CREATE INDEX idx_counter_lookup
ON document_number_counters (
  project_id,
  correspondence_type_id,
  current_year
);

-- Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Originator lookup
CREATE INDEX idx_counter_org
ON document_number_counters (
  originator_organization_id,
  current_year
);
```

### 3.11.14.3. Important Notes

> **üí° Counter Key Design**
> - ‡πÉ‡∏ä‡πâ `COALESCE(recipient_organization_id, 0)` ‡πÉ‡∏ô Primary Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö NULL
> - `version` column ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Optimistic Locking (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition)
> - `last_number` ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0 ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡∏•‡∏∞ 1
> - Counter reset ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡πÄ‡∏°‡∏∑‡πà‡∏≠ `current_year` ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)

> **‚ö†Ô∏è Migration Notes**
> - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ backward compatibility
> - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á table ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ï‡∏≤‡∏° schema ‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô
> - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ seed data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö `correspondence_types`, `rfa_types`, `disciplines` ‡∏Å‡πà‡∏≠‡∏ô

### 3.11.14.4. Example Counter Records

```sql
-- Example: LETTER from ‡∏Ñ‡∏Ñ‡∏á. to ‡∏™‡∏Ñ‡∏â.3 in LCBP3-C2 year 2025
INSERT INTO document_number_counters (
  project_id, originator_organization_id, recipient_organization_id,
  correspondence_type_id, sub_type_id, rfa_type_id, discipline_id,
  current_year, version, last_number
) VALUES (
  2,      -- LCBP3-C2
  22,     -- ‡∏Ñ‡∏Ñ‡∏á.
  10,     -- ‡∏™‡∏Ñ‡∏â.3
  6,      -- LETTER
  0, 0, 0,
  2025, 0, 0
);

-- Example: RFA from ‡∏ú‡∏£‡∏°.2 in LCBP3-C2, discipline TER, type RPT, year 2025
INSERT INTO document_number_counters (
  project_id, originator_organization_id, recipient_organization_id,
  correspondence_type_id, sub_type_id, rfa_type_id, discipline_id,
  current_year, version, last_number
) VALUES (
  2,      -- LCBP3-C2
  42,     -- ‡∏ú‡∏£‡∏°.2
  NULL,   -- RFA ‡πÑ‡∏°‡πà‡∏°‡∏µ specific recipient
  1,      -- RFA
  0,
  18,     -- RPT (Report)
  5,      -- TER (Terminal)
  2025, 0, 0
);
```

## 3.11.15. Security Considerations

### 3.11.14.1. Authorization

- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ authenticated users ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ request document number
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Project Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡πÑ‡∏î‡πâ
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà reset counter ‡πÑ‡∏î‡πâ

### 3.11.14.2. Rate Limiting

- Limit ‡∏ï‡πà‡∏≠ user: **10 requests/minute** (prevent abuse)
- Limit ‡∏ï‡πà‡∏≠ IP: **50 requests/minute**

### 3.11.14.3. Audit & Compliance

- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å API call ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö document numbering
- ‡πÄ‡∏Å‡πá‡∏ö audit log ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **7 ‡∏õ‡∏µ** (‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå)
