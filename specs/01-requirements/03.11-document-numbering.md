# 3.11 Document Numbering Management (‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)

---
title: 'Functional Requirements: Document Numbering Management'
version: 1.5.0
status: first-draft
owner: Nattanin Peancharoen
last_updated: 2025-12-02
related:
  - specs/01-requirements/01-objectives.md
  - specs/01-requirements/02-architecture.md
  - specs/01-requirements/03-functional-requirements.md
  - specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md
---

## 3.11.1. ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå

- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Running Number) ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (template) ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô Uniqueness ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö concurrent ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

## 3.11.2. Logic ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç (Counter Logic)

‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° **Counter Key** ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢:

- `project_id` - ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
- `doc_type_id` - ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Correspondence, RFA, Transmittal, Drawing)
- `sub_type_id` - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (nullable)
- `discipline_id` - ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤/‡∏á‡∏≤‡∏ô (nullable)
- `year` - ‡∏õ‡∏µ ‡∏û.‡∏®. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏Ñ.‡∏®. ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô template

### ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Counter Key

```text
Correspondence: project_id + doc_type_id + sub_type_id + year
RFA:           project_id + doc_type_id + discipline_id + year
Transmittal:   project_id + doc_type_id + recipient_type + year
Drawing:       project_id + doc_type_id + discipline_id + year
```

### Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ NULL

- ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà `discipline_id` ‡∏´‡∏£‡∏∑‡∏≠ `sub_type_id` ‡πÄ‡∏õ‡πá‡∏ô NULL ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Default `0` ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° Counter
- ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Error ‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á Running Number (Uniqueness Guarantee)

## 3.11.3. Format Templates by Document Type

‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ **Token Replacement**

### 3.11.3.1. Correspondence (‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)

#### Letter Type (TYPE = 03)

- **Template**: `{ORG}-{ORG}-{TYPE}-{SEQ:4}-{YEAR:B.E.}`
- **Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-0985-2568`
- **Counter Key**: `project_id + doc_type_id + sub_type_id + year`

#### Other Correspondence Types

- **Template**: `{ORG}-{ORG}-{TYPE}-{SEQ:4}-{YEAR:B.E.}`
- **Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-STR-0001-2568`
- **Counter Key**: `project_id + doc_type_id + sub_type_id + year`

### 3.11.3.2. Transmittal

#### Transmittal to Owner

- **Template**: `{ORG}-{ORG}-{TYPE}-{SUB_TYPE}-{SEQ:4}-{YEAR:B.E.}`
- **Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-03-21-0117-2568`
- **Counter Key**: `project_id + doc_type_id + recipient_type + year`
- **Note**: `recipient_type = 'OWNER'`

#### Transmittal to Contractor/Others

- **Template**: `{ORG}-{ORG}-{TYPE}-{SEQ:4}-{YEAR:B.E.}`
- **Example**: `‡∏ú‡∏£‡∏°.2-‡∏Ñ‡∏Ñ‡∏á.-0117-2568`
- **Counter Key**: `project_id + doc_type_id + recipient_type + year`
- **Note**: `recipient_type = 'CONTRACTOR' | 'CONSULTANT' | 'OTHER'`

#### Alternative Project-based Format

- **Template**: `{PROJECT}-{ORG}-{TYPE}-{DISCIPLINE}-{SEQ:4}-{REV}`
- **Example**: `LCBP3-TR-STR-0001-A`
- **Counter Key**: `project_id + doc_type_id + discipline_id + year`

### 3.11.3.3. RFA (Request for Approval)

- **Template**: `{PROJECT}-{ORG}-{TYPE}-{DISCIPLINE}-{SEQ:4}-{REV}`
- **Example**: `LCBP3-C2-RFI-ROW-0029-A`
- **Counter Key**: `project_id + doc_type_id + discipline_id + year`
- **Note**: `{REV}` ‡∏Ñ‡∏∑‡∏≠ revision code (A, B, C, ..., AA, AB, ...)

### 3.11.3.4. Drawing

- **Template**: `{PROJECT}-{DISCIPLINE}-{CATEGORY}-{SEQ:4}-{REV}`
- **Example**: `LCBP3-STR-DRW-0001-A`
- **Counter Key**: `project_id + doc_type_id + discipline_id + category + year`

## 3.11.4. Supported Token Types

| Token | Description | Example |
|-------|-------------|---------|
| `{PROJECT}` | ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ | `LCBP3` |
| `{ORG}` | ‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô | `‡∏Ñ‡∏Ñ‡∏á.`, `‡∏™‡∏Ñ‡∏â.3` |
| `{TYPE}` | ‡∏£‡∏´‡∏±‡∏™‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ | `RFI`, `03` |
| `{SUB_TYPE}` | ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ | `21` |
| `{DISCIPLINE}` | ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ | `STR`, `ROW` |
| `{CATEGORY}` | ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà | `DRW` |
| `{SEQ:n}` | Running number (n = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å) | `0001`, `0029` |
| `{YEAR:B.E.}` | ‡∏õ‡∏µ ‡∏û.‡∏®. | `2568` |
| `{YEAR:A.D.}` | ‡∏õ‡∏µ ‡∏Ñ.‡∏®. | `2025` |
| `{REV}` | Revision Code | `A`, `B`, `AA` |

## 3.11.5. Transmittal Special Logic

- Transmittal ‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏Ç‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö:
  - **To Owner**: ‡πÉ‡∏ä‡πâ format ‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏ó‡∏µ‡πà‡∏°‡∏µ sub_type ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
  - **To Contractor/Others**: ‡πÉ‡∏ä‡πâ format ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
- Counter Key ‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° `recipient_type` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏°‡∏µ running number ‡∏≠‡∏¥‡∏™‡∏£‡∏∞

## 3.11.6. ‡∏Å‡∏•‡πÑ‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Concurrency Control)

### 3.11.6.1. Redis Distributed Lock

- ‡πÉ‡∏ä‡πâ Redis Distributed Lock ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition
- Lock key format: `lock:docnum:{project_id}:{doc_type_id}:{...counter_key_parts}`
- Lock TTL: 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (auto-release ‡πÄ‡∏°‡∏∑‡πà‡∏≠ timeout)
- Lock acquisition timeout: 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ

### 3.11.6.2. Optimistic Locking

- ‡πÉ‡∏ä‡πâ `version` column ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á `document_number_configs`
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö version ‡∏Å‡πà‡∏≠‡∏ô update counter
- ‡∏´‡∏≤‡∏Å version conflict ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‚Üí retry transaction

### 3.11.6.3. Database Constraints

- Unique constraint ‡∏ö‡∏ô `document_number` column
- Foreign key constraints ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- Check constraints ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö business rules

## 3.11.7. Retry Mechanism & Error Handling

### 3.11.7.1. Scenario 1: Redis Unavailable

- **Fallback**: ‡πÉ‡∏ä‡πâ database-only locking (pessimistic lock)
- **Action**:
  - ‡πÉ‡∏ä‡πâ `SELECT ... FOR UPDATE` ‡πÅ‡∏ó‡∏ô Redis lock
  - Log warning ‡∏û‡∏£‡πâ‡∏≠‡∏° alert ops team
  - ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà performance ‡∏•‡∏î‡∏•‡∏á

### 3.11.7.2. Scenario 2: Lock Acquisition Timeout

- **Retry**: 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ exponential backoff
  - Attempt 1: wait 1s
  - Attempt 2: wait 2s
  - Attempt 3: wait 4s
  - Attempt 4: wait 8s
  - Attempt 5: wait 16s (‡∏£‡∏ß‡∏° ~31 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
- **Failure**: Return HTTP 503 "Service Temporarily Unavailable"
- **Frontend**: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∏‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á"

### 3.11.7.3. Scenario 3: Version Conflict After Lock

- **Retry**: 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á (reload counter + retry transaction)
- **Failure**: Log error ‡∏û‡∏£‡πâ‡∏≠‡∏° context ‡πÅ‡∏•‡∏∞ return HTTP 409 Conflict
- **Frontend**: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà"

### 3.11.7.4. Scenario 4: Database Connection Error

- **Retry**: 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢ exponential backoff (1s, 2s, 4s)
- **Failure**: Return HTTP 500 "Internal Server Error"
- **Frontend**: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö"

## 3.11.8. Configuration Management

### 3.11.8.1. Admin Panel Configuration

- Project Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡∏ú‡πà‡∏≤‡∏ô Admin Panel
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á template ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß
- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£ validate template ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö token ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)

### 3.11.8.2. Template Versioning

- ‡πÄ‡∏Å‡πá‡∏ö history ‡∏Ç‡∏≠‡∏á template changes
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å user, timestamp, ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ rollback ‡πÑ‡∏õ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ

### 3.11.8.3. Counter Reset Policy

- Counter reset ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ (yearly reset)
- Counter reset ‡∏ï‡∏≤‡∏° project phase (optional)
- Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ manual reset counter ‡πÑ‡∏î‡πâ (require approval + audit log)

## 3.11.9. Audit Trail

### 3.11.9.1. ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Audit Log

‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏£ generate ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô `document_number_audit` table:

- `document_id` - ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
- `generated_number` - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
- `counter_key` - key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö
- `template_used` - template ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
- `user_id` - ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà request
- `ip_address` - IP address ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ request
- `timestamp` - ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
- `retry_count` - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà retry (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)

### 3.11.9.2. Conflict & Error Logging

- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å version conflicts ‡πÅ‡∏•‡∏∞ ‡∏Å‡∏•‡πÑ‡∏Å retry ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å lock timeouts ‡πÅ‡∏•‡∏∞ failure reasons
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å fallback scenarios (‡πÄ‡∏ä‡πà‡∏ô Redis unavailable)

## 3.11.10. Performance Requirements

### 3.11.10.1. Response Time

- Document number generation ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô **2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ** (95th percentile)
- Document number generation ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô **5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ** (99th percentile)
- ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ normal operation (‡πÑ‡∏°‡πà‡∏°‡∏µ retry) ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏†‡∏≤‡∏¢‡πÉ‡∏ô **500ms**

### 3.11.10.2. Throughput

- ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö concurrent requests ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **50 requests/second**
- Peak load ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏∂‡∏á **100 requests/second** (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡πà‡∏á‡∏á‡∏≤‡∏ô)

### 3.11.10.3. Availability

- Uptime ‚â• 99.5% (exclude planned maintenance)
- Maximum downtime ‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚â§ 3.6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á

## 3.11.11. Monitoring & Alerting

### 3.11.11.1. Metrics to Monitor

- Lock acquisition time (p50, p95, p99)
- Lock acquisition failure rate
- Counter generation latency
- Retry count distribution
- Redis connection status
- Database connection pool usage

### 3.11.11.2. Alert Conditions

- üî¥ **Critical**: Redis unavailable > 1 minute
- üî¥ **Critical**: Lock acquisition failures > 10% in 5 minutes
- üü° **Warning**: Lock acquisition failures > 5% in 5 minutes
- üü° **Warning**: Average lock wait time > 1 second
- üü° **Warning**: Retry count > 100 per hour

### 3.11.11.3. Dashboard

- Real-time lock acquisition success rate
- Lock wait time percentiles (p50, p95, p99)
- Counter generation rate (per minute)
- Error rate breakdown (by error type)
- Redis/Database health status

## 3.11.12. API Reference

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á API endpoints ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô `specs/02-architecture/api-design.md`):

- `POST /api/v1/documents/{documentId}/generate-number` - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- `GET /api/v1/document-numbering/configs` - ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ template
- `PUT /api/v1/document-numbering/configs/{configId}` - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template (Admin only)
- `POST /api/v1/document-numbering/configs/{configId}/reset-counter` - Reset counter (Admin only)

## 3.11.13. Database Schema Reference

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á tables ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô `specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md`):

- `document_number_configs` - ‡πÄ‡∏Å‡πá‡∏ö template ‡πÅ‡∏•‡∏∞ counter configuration
- `document_number_counters` - ‡πÄ‡∏Å‡πá‡∏ö current counter value
- `document_number_audit` - ‡πÄ‡∏Å‡πá‡∏ö audit trail
- `documents` - ‡πÄ‡∏Å‡πá‡∏ö document number ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á

## 3.11.14. Security Considerations

### 3.11.14.1. Authorization

- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ authenticated users ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ request document number
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Project Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡πÑ‡∏î‡πâ
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà reset counter ‡πÑ‡∏î‡πâ

### 3.11.14.2. Rate Limiting

- Limit ‡∏ï‡πà‡∏≠ user: **10 requests/minute** (prevent abuse)
- Limit ‡∏ï‡πà‡∏≠ IP: **50 requests/minute**

### 3.11.14.3. Audit & Compliance

- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å API call ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö document numbering
- ‡πÄ‡∏Å‡πá‡∏ö audit log ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **7 ‡∏õ‡∏µ** (‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå)
