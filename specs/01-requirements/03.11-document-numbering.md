# 3.11 Document Numbering Management (‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£)

---
title: 'Functional Requirements: Document Numbering Management'
version: 1.6.0
status: draft
owner: Nattanin Peancharoen
last_updated: 2025-12-02
related:

- specs/01-requirements/01-objectives.md
- specs/01-requirements/02-architecture.md
- specs/01-requirements/03-functional-requirements.md
- specs/03-implementation/document-numbering.md
- specs/04-operations/document-numbering-operations.md
- specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md

---

> **üìñ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á**
>
> - **Implementation Guide**: [document-numbering.md](file:///e:/np-dms/lcbp3/specs/03-implementation/document-numbering.md) - ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£ implement ‡∏î‡πâ‡∏ß‡∏¢ NestJS, TypeORM, Redis
> - **Operations Guide**: [document-numbering-operations.md](file:///e:/np-dms/lcbp3/specs/04-operations/document-numbering-operations.md) - Monitoring, Troubleshooting, Maintenance Procedures

## 3.11.1. ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå

- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Running Number) ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏™‡∏π‡∏á
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (template) ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£, ‡∏ä‡∏ô‡∏¥‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô Uniqueness ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö concurrent ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢

## 3.11.2. Logic ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç (Counter Logic)

‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡πÄ‡∏•‡∏Ç‡∏à‡∏∞‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° **Counter Key** ‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏•‡∏≤‡∏¢‡∏™‡πà‡∏ß‡∏ô ‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£

### Counter Key Components

| Component                    | Required?        | Description         | Database Source                                           | Default if NULL |
| ---------------------------- | ---------------- | ------------------- | --------------------------------------------------------- | --------------- |
| `project_id`                 | ‚úÖ Yes            | ID ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£          | Derived from user context or organization                 | -               |
| `originator_organization_id` | ‚úÖ Yes            | ID ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á         | `correspondences.originator_id`                           | -               |
| `recipient_organization_id`  | Depends on type  | ID ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO) | `correspondence_recipients` where `recipient_type = 'TO'` | NULL for RFA    |
| `correspondence_type_id`     | ‚úÖ Yes            | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£     | `correspondence_types.id`                                 | -               |
| `sub_type_id`                | TRANSMITTAL only | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢        | `correspondence_sub_types.id`                             | 0               |
| `rfa_type_id`                | RFA only         | ID ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA       | `rfa_types.id`                                            | 0               |
| `discipline_id`              | RFA only         | ID ‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô          | `disciplines.id`                                          | 0               |
| `current_year`               | ‚úÖ Yes            | ‡∏õ‡∏µ ‡∏Ñ.‡∏®.              | System year (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)                                       | -               |

### Counter Key ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£

**LETTER / RFI / MEMO / EMAIL / MOM / INSTRUCTION / NOTICE / OTHER**:

```
(project_id, originator_organization_id, recipient_organization_id,
 correspondence_type_id, 0, 0, 0, current_year)
```

*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏*: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ `discipline_id`, `sub_type_id`, `rfa_type_id`

**TRANSMITTAL**:

```
(project_id, originator_organization_id, recipient_organization_id,
 correspondence_type_id, sub_type_id, 0, 0, current_year)
```

*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏*: ‡πÉ‡∏ä‡πâ `sub_type_id` ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°

**RFA**:

```
(project_id, originator_organization_id, NULL,
 correspondence_type_id, 0, rfa_type_id, discipline_id, current_year)
```

*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏*: RFA ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ `recipient_organization_id` ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (CONTRACTOR ‚Üí CONSULTANT ‚Üí OWNER)

### ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏´‡∏≤ project_id

‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å Template ‡∏Ç‡∏≠‡∏á LETTER/TRANSMITTAL ‡πÑ‡∏°‡πà‡∏°‡∏µ `{PROJECT}` token ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏´‡∏≤ `project_id` ‡∏à‡∏≤‡∏Å:

1. **User Context** (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥):
   - ‡πÄ‡∏°‡∏∑‡πà‡∏≠ User ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ UI ‡∏à‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Project/Contract ‡∏Å‡πà‡∏≠‡∏ô
   - ‡πÉ‡∏ä‡πâ `project_id` ‡∏à‡∏≤‡∏Å Context ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

2. **‡∏à‡∏≤‡∏Å Organization**:
   - Query `project_organizations` ‡∏´‡∏£‡∏∑‡∏≠ `contract_organizations`
   - ‡πÉ‡∏ä‡πâ `originator_organization_id` ‡∏´‡∏≤ project ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á
   - ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ project ‡πÉ‡∏´‡πâ User ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

3. **Validation**:
   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ organization ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô project ‡∏ô‡∏±‡πâ‡∏ô
   - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ project/contract ‡πÄ‡∏õ‡πá‡∏ô active

### Fallback ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ NULL

- `discipline_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô)
- `sub_type_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢)
- `rfa_type_id`: ‡πÉ‡∏ä‡πâ `0` (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA)
- `recipient_organization_id`: ‡πÉ‡∏ä‡πâ `NULL` ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFA, Required ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LETTER/TRANSMITTAL

## 3.11.3. Format Templates by Correspondence Type

> **üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç**
>
> - Templates ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å
> - ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö **‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£** ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô `correspondence_types` table
> - ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
> - Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Template ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡πà‡∏≤‡∏ô Admin Panel

### 3.11.3.1. Letter (TYPE = LETTER)

**Template**:

```
{ORIGINATOR}-{RECIPIENT}-{SEQ:4}-{YEAR:B.E.}
```

**Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-0001-2568`

**Token Breakdown**:

- `‡∏Ñ‡∏Ñ‡∏á.` = {ORIGINATOR} = ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á
- `‡∏™‡∏Ñ‡∏â.3` = {RECIPIENT} = ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO)
- `0001` = {SEQ:4} = Running number (‡πÄ‡∏£‡∏¥‡πà‡∏° 0001, 0002, ...)
- `2568` = {YEAR:B.E.} = ‡∏õ‡∏µ ‡∏û.‡∏®.

> **‚ö†Ô∏è Template vs Counter Separation**
>
> - {CORR_TYPE} **‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á**‡πÉ‡∏ô template ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö
> - ‡πÅ‡∏ï‡πà‡∏£‡∏∞‡∏ö‡∏ö**‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ correspondence_type_id ‡πÉ‡∏ô Counter Key** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏¢‡∏Å counter
> - LETTER, MEMO, RFI **‡∏°‡∏µ counter ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô** ‡πÅ‡∏°‡πâ template format ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô

**Counter Key**: `(project_id, originator_org_id, recipient_org_id, corr_type_id, 0, 0, 0, year)`

---

### 3.11.3.2. Transmittal (TYPE = TRANSMITTAL)

**Template**:

```
{ORIGINATOR}-{RECIPIENT}-{SUB_TYPE}-{SEQ:4}-{YEAR:B.E.}
```

**Example**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-21-0117-2568`

**Token Breakdown**:

- `‡∏Ñ‡∏Ñ‡∏á.` = {ORIGINATOR}
- `‡∏™‡∏Ñ‡∏â.3` = {RECIPIENT}
- `21` = {SUB_TYPE} = ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ (11=MAT, 12=SHP, 13=DWG, 14=MET, ...)
- `0117` = {SEQ:4}
- `2568` = {YEAR:B.E.}

> **‚ö†Ô∏è Template vs Counter Separation**
>
> - {CORR_TYPE} **‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á**‡πÉ‡∏ô template (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô LETTER)
> - TRANSMITTAL ‡∏°‡∏µ counter ‡πÅ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å LETTER

**Counter Key**: `(project_id, originator_org_id, recipient_org_id, corr_type_id, sub_type_id, 0, 0, year)`

---

### 3.11.3.3. RFA (Request for Approval)

**Template**:

```
{PROJECT}-{CORR_TYPE}-{DISCIPLINE}-{RFA_TYPE}-{SEQ:4}-{REV}
```

**Example**: `LCBP3-C2-RFA-TER-RPT-0001-A`

**Token Breakdown**:

- `LCBP3-C2` = {PROJECT} = ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
- `RFA` = {CORR_TYPE} = ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (**‡πÅ‡∏™‡∏î‡∏á**‡πÉ‡∏ô RFA template)
- `TER` = {DISCIPLINE} = ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏á‡∏≤‡∏ô (TER=Terminal, STR=Structure, ...)
- `RPT` = {RFA_TYPE} = ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA (RPT=Report, SDW=Shop Drawing, ...)
- `0001` = {SEQ:4}
- `A` = {REV} = Revision code

> **üìã RFA Workflow**
>
> - RFA ‡πÄ‡∏õ‡πá‡∏ô **‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£** (Project-level document)
> - Workflow: **CONTRACTOR ‚Üí CONSULTANT ‚Üí OWNER**
> - ‡πÑ‡∏°‡πà‡∏°‡∏µ specific `recipient_id` ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô workflow ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß

**Counter Key**: `(project_id, originator_org_id, NULL, corr_type_id, 0, rfa_type_id, discipline_id, year)`

---

### 3.11.3.4. Drawing

**Status**: üöß **To Be Determined**

Drawing Numbering ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Template ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å:

- ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏™‡∏π‡∏á (Contract Drawing ‡πÅ‡∏•‡∏∞ Shop Drawing ‡∏°‡∏µ‡∏Å‡∏é‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô)
- ‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Numbering ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
- ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö RFA ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á

---

### 3.11.3.5. Other Correspondence Types

**Applicable to**: RFI, MEMO, EMAIL, MOM, INSTRUCTION, NOTICE, OTHER

**Template**:

```
{ORIGINATOR}-{RECIPIENT}-{SEQ:4}-{YEAR:B.E.}
```

**Example (RFI)**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-0042-2568`
**Example (MEMO)**: `‡∏Ñ‡∏Ñ‡∏á.-‡∏ú‡∏£‡∏°.1-0001-2568`

> **üîë Counter Separation**
>
> - ‡πÅ‡∏°‡πâ template format **‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö LETTER**
> - ‡πÅ‡∏ï‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞ type ‡∏°‡∏µ **counter ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô** ‡∏ú‡πà‡∏≤‡∏ô `correspondence_type_id`
> - RFI counter ‚â† MEMO counter ‚â† LETTER counter

**Counter Key**: `(project_id, originator_org_id, recipient_org_id, corr_type_id, 0, 0, 0, year)`

**‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏**: ‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∞‡πÉ‡∏ä‡πâ Template ‡∏ô‡∏µ‡πâ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏° correspondence type ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô `correspondence_types` table ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Template ‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥

## 3.11.4. Supported Token Types

| Token          | Description                  | Example                        | Database Source                                                                                 |
| -------------- | ---------------------------- | ------------------------------ | ----------------------------------------------------------------------------------------------- |
| `{PROJECT}`    | ‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£                   | `LCBP3`, `LCBP3-C2`            | `projects.project_code`                                                                         |
| `{ORIGINATOR}` | ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á                  | `‡∏Ñ‡∏Ñ‡∏á.`, `‡∏ú‡∏£‡∏°.1`                | `organizations.organization_code` via `correspondences.originator_id`                           |
| `{RECIPIENT}`  | ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å (TO)          | `‡∏™‡∏Ñ‡∏â.3`, `‡∏Å‡∏ó‡∏ó.`                | `organizations.organization_code` via `correspondence_recipients` where `recipient_type = 'TO'` |
| `{CORR_TYPE}`  | ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£              | `RFA`, `TRANSMITTAL`, `LETTER` | `correspondence_types.type_code`                                                                |
| `{SUB_TYPE}`   | ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢             | `11`, `12`, `21`               | `correspondence_sub_types.sub_type_number`                                                      |
| `{RFA_TYPE}`   | ‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA                | `SDW`, `RPT`, `MAT`            | `rfa_types.type_code`                                                                           |
| `{DISCIPLINE}` | ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤                   | `STR`, `TER`, `GEO`            | `disciplines.discipline_code`                                                                   |
| `{SEQ:n}`      | Running number (n = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å) | `0001`, `0029`, `0985`         | Based on `document_number_counters.last_number + 1`                                             |
| `{YEAR:B.E.}`  | ‡∏õ‡∏µ ‡∏û.‡∏®.                       | `2568`                         | `document_number_counters.current_year + 543`                                                   |
| `{YEAR:A.D.}`  | ‡∏õ‡∏µ ‡∏Ñ.‡∏®.                       | `2025`                         | `document_number_counters.current_year`                                                         |
| `{REV}`        | Revision Code                | `A`, `B`, `AA`                 | `correspondence_revisions.revision_label`                                                       |

### Token Usage Notes

**{SEQ:n}**:

- `n` = ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (typically 4)
- Counter **‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0001** ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞ 1 (0001, 0002, 0003, ...)
- Padding ‡∏î‡πâ‡∏ß‡∏¢ 0 ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
- Reset ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡∏ï‡∏≤‡∏° `current_year` ‡πÉ‡∏ô Counter Key)

**{RECIPIENT}**:

- ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ `recipient_type = 'TO'` ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ TO ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡πÅ‡∏£‡∏Å (‡∏ï‡∏≤‡∏° sort order)
- **‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö RFA** (RFA ‡πÑ‡∏°‡πà‡∏°‡∏µ {RECIPIENT} ‡πÉ‡∏ô template)

**{CORR_TYPE}**:

- ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å `correspondence_types.type_code`
- ‡∏ñ‡πâ‡∏≤‡∏°ÔøΩ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏´‡∏°‡πà ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
- **‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô template**: RFA only
- **‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô counter**: LETTER, TRANSMITTAL, ‡πÅ‡∏•‡∏∞ Other types

**Deprecated Tokens** (‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ):

- ~~`{ORG}`~~ ‚Üí ‡πÉ‡∏ä‡πâ `{ORIGINATOR}` ‡∏´‡∏£‡∏∑‡∏≠ `{RECIPIENT}` ‡πÅ‡∏ó‡∏ô
- ~~`{TYPE}`~~ ‚Üí ‡πÉ‡∏ä‡πâ `{CORR_TYPE}`, `{SUB_TYPE}`, ‡∏´‡∏£‡∏∑‡∏≠ `{RFA_TYPE}` ‡πÅ‡∏ó‡∏ô (‡∏ï‡∏≤‡∏°‡∏ö‡∏£‡∏¥‡∏ö‡∏ó)
- ~~`{CATEGORY}`~~ ‚Üí ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô

## 3.11.5. Security & Data Integrity Requirements

### 3.11.5.1. Concurrency Control

**Requirements:**

- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô uniqueness ‡∏Ç‡∏≠‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏Ñ‡∏ß‡∏£**‡πÉ‡∏ä‡πâ Distributed Lock (Redis) ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡πÑ‡∏Å primary
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏°‡∏µ fallback mechanism ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Redis ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

**Implementation Details:** ‡∏î‡∏π [Implementation Guide - Section 2.3](file:///e:/np-dms/lcbp3/specs/03-implementation/document-numbering.md#23-redis-lock-service)

### 3.11.5.2. Data Integrity

**Requirements:**

- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡πÉ‡∏ä‡πâ Optimistic Locking ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö concurrent updates
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏°‡∏µ database constraints ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:
  - Unique constraint ‡∏ö‡∏ô `document_number`
  - Foreign key constraints ‡∏ó‡∏∏‡∏Å relationship
  - Check constraints ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö business rules

### 3.11.5.3. Authorization

**Requirements:**

- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **authenticated users** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ request document number
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **Project Admin** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡πÑ‡∏î‡πâ
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **Super Admin** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà reset counter ‡πÑ‡∏î‡πâ (requires approval)

## 3.11.6. Error Handling Requirements

### 3.11.6.1. Retry Mechanism

**Requirements:**

‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ error scenarios ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

| Scenario            | Strategy            | Max Retries | Expected Response               |
| ------------------- | ------------------- | ----------- | ------------------------------- |
| Redis Unavailable   | Fallback to DB Lock | 0           | Continue (degraded performance) |
| Lock Timeout        | Exponential Backoff | 5           | HTTP 503 after final retry      |
| Version Conflict    | Immediate Retry     | 2           | HTTP 409 after final retry      |
| DB Connection Error | Exponential Backoff | 3           | HTTP 500 after final retry      |

**Implementation Details:** ‡∏î‡∏π [Implementation Guide - Section 2.5](file:///e:/np-dms/lcbp3/specs/03-implementation/document-numbering.md#25-main-service-with-retry-logic)

### 3.11.6.2. User Experience

**Requirements:**

- Error messages **‡∏ï‡πâ‡∏≠‡∏á**‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
- HTTP status codes **‡∏ï‡πâ‡∏≠‡∏á**‡∏™‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
- Frontend **‡∏Ñ‡∏ß‡∏£**‡πÅ‡∏™‡∏î‡∏á retry option ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö transient errors

## 3.11.7. Configuration Management Requirements

### 3.11.7.1. Template Management

**Requirements:**

- Project Admin **‡∏ï‡πâ‡∏≠‡∏á**‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡∏ú‡πà‡∏≤‡∏ô Admin Panel
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**validate template ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á template **‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà**‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß

### 3.11.7.2. Template Versioning

**Requirements:**

- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡πÄ‡∏Å‡πá‡∏ö history ‡∏Ç‡∏≠‡∏á template changes
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å user, timestamp, ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏Ñ‡∏ß‡∏£**‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ rollback ‡πÑ‡∏õ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ

### 3.11.7.3. Counter Reset Policy

**Requirements:**

- Counter **‡∏ï‡πâ‡∏≠‡∏á**reset ‡∏ï‡∏≤‡∏°‡∏õ‡∏µ (‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
- Admin **‡∏ï‡πâ‡∏≠‡∏á**‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ manual reset counter ‡πÑ‡∏î‡πâ (require approval + audit log)

**Implementation Details:** ‡∏î‡∏π [Implementation Guide - Section 4](file:///e:/np-dms/lcbp3/specs/03-implementation/document-numbering.md#4-bullmq-job-for-counter-reset)

## 3.11.8. Audit Trail Requirements

### 3.11.8.1. Audit Logging

**Requirements:**

‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å document number generation:

- `document_id` - ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
- `generated_number` - ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á
- `counter_key` - key ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö (JSON format)
- `template_used` - template ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
- `user_id` - ‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà request
- `ip_address` - IP address ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ request
- `timestamp` - ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á
- `retry_count` - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà retry
- `performance_metrics` - Lock wait time, total duration

### 3.11.8.2. Error Logging

**Requirements:**

- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å error ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏° error type classification
- ‡∏£‡∏∞‡∏ö‡∏ö**‡∏Ñ‡∏ß‡∏£**alert ops team ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö critical errors

### 3.11.8.3. Retention Policy

**Requirements:**

- Audit log **‡∏ï‡πâ‡∏≠‡∏á**‡πÄ‡∏Å‡πá‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **7 ‡∏õ‡∏µ** (‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå)

## 3.11.9. Performance Requirements

### 3.11.9.1. Response Time

**SLA Targets:**

| Metric           | Target   | Notes                    |
| ---------------- | -------- | ------------------------ |
| 95th percentile  | ‚â§ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà request ‡∏ñ‡∏∂‡∏á response |
| 99th percentile  | ‚â§ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ | ‡∏£‡∏ß‡∏° retry attempts       |
| Normal operation | ‚â§ 500ms  | ‡πÑ‡∏°‡πà‡∏°‡∏µ retry                |

### 3.11.9.2. Throughput

**Capacity Targets:**

| Load Level  | Target      | Notes     |
| ----------- | ----------- | --------- |
| Normal load | ‚â• 50 req/s  | ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥  |
| Peak load   | ‚â• 100 req/s | ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏á‡∏á‡∏≤‡∏ô |

### 3.11.9.3. Availability

**SLA Targets:**

- **Uptime**: ‚â• 99.5% (excluding planned maintenance)
- **Maximum downtime**: ‚â§ 3.6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- **RTO**: ‚â§ 30 ‡∏ô‡∏≤‡∏ó‡∏µ
- **RPO**: ‚â§ 5 ‡∏ô‡∏≤‡∏ó‡∏µ

**Operations Details:** ‡∏î‡∏π [Operations Guide - Section 1](file:///e:/np-dms/lcbp3/specs/04-operations/document-numbering-operations.md#1-performance-requirements)

## 3.11.10. Monitoring & Alerting Requirements

### 3.11.10.1. Metrics

**Requirements:**

‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**collect metrics ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

- Lock acquisition time (p50, p95, p99)
- Lock acquisition success/failure rate
- Counter generation latency
- Retry count distribution
- Redis connection status
- Database connection pool usage

### 3.11.10.2. Alerts

**Requirements:**

‡∏£‡∏∞‡∏ö‡∏ö**‡∏ï‡πâ‡∏≠‡∏á**alert ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö conditions ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

| Severity   | Condition                    | Action            |
| ---------- | ---------------------------- | ----------------- |
| üî¥ Critical | Redis unavailable > 1 minute | PagerDuty + Slack |
| üî¥ Critical | Lock failures > 10% in 5 min | PagerDuty + Slack |
| üü° Warning  | Lock failures > 5% in 5 min  | Slack             |
| üü° Warning  | Avg lock wait time > 1 sec   | Slack             |
| üü° Warning  | Retry count > 100/hour       | Slack             |

### 3.11.10.3. Dashboard

**Requirements:**

- Ops team **‡∏ï‡πâ‡∏≠‡∏á**‡∏°‡∏µ real-time dashboard ‡πÅ‡∏™‡∏î‡∏á:
  - Lock acquisition success rate
  - Lock wait time percentiles
  - Generation rate (per minute)
  - Error rate by type
  - Connection health status

**Operations Details:** ‡∏î‡∏π [Operations Guide - Section 3](file:///e:/np-dms/lcbp3/specs/04-operations/document-numbering-operations.md#3-monitoring--metrics)


## 3.11.11. API Reference

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á API endpoints ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

### Document Number Generation

```http
POST /api/v1/documents/{documentId}/generate-number
```

‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö document ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏

**Request Body:**

```json
{
  "counterKey": {
    "projectId": 2,
    "originatorOrgId": 22,
    "recipientOrgId": 10,
    "correspondenceTypeId": 6,
    "subTypeId": 0,
    "rfaTypeId": 0,
    "disciplineId": 0,
    "year": 2025
  }
}
```

**Response:**

```json
{
  "documentNumber": "‡∏Ñ‡∏Ñ‡∏á.-‡∏™‡∏Ñ‡∏â.3-0001-2568",
  "generatedAt": "2025-12-02T15:30:00Z"
}
```

### Template Management

```http
GET /api/v1/document-numbering/configs
```

‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ template configuration ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

```http
PUT /api/v1/document-numbering/configs/{configId}
```

‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template (Project Admin only)

```http
POST /api/v1/document-numbering/configs/{configId}/reset-counter
```

Reset counter (Super Admin only, requires approval)

**‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°:** ‡∏î‡∏π [API Design](file:///e:/np-dms/lcbp3/specs/02-architecture/api-design.md)

## 3.11.12. Database Schema Reference

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á database tables ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:

### Core Tables

- `document_number_counters` - ‡πÄ‡∏Å‡πá‡∏ö counter values ‡πÅ‡∏•‡∏∞ template configuration
- `document_number_audit` - ‡πÄ‡∏Å‡πá‡∏ö audit trail ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£ generate ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà
- `document_number_errors` - ‡πÄ‡∏Å‡πá‡∏ö error logs

### Related Tables

- `documents` - ‡πÄ‡∏Å‡πá‡∏ö document number ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á (column: `document_number` UNIQUE)
- `correspondence_types` - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (LETTER, RFA, TRANSMITTAL, etc.)
- `correspondence_sub_types` - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏¢‡πà‡∏≠‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TRANSMITTAL)
- `rfa_types` - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó RFA (SHD, RPT, MAT, etc.)
- `disciplines` - ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤ (TER, STR, GEO, etc.)
- `projects` - ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£
- `organizations` - ‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£

**Schema Details:** ‡∏î‡∏π [Implementation Guide - Section 1](file:///e:/np-dms/lcbp3/specs/03-implementation/document-numbering.md#1-database-implementation)

## 3.11.13. Database Schema Requirements

### 3.11.13.1. Counter Table Schema Requirements

**Primary Table**: `document_number_counters`

**Required Columns:**
- Composite primary key: `(project_id, originator_organization_id, recipient_organization_id, correspondence_type_id, sub_type_id, rfa_type_id, discipline_id, current_year)`
- `version` - ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö optimistic locking
- `last_number` - counter value (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0)

**Important Notes:**
- ‡πÉ‡∏ä‡πâ `COALESCE(recipient_organization_id, 0)` ‡πÉ‡∏ô Primary Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö NULL
- Counter reset ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡πÄ‡∏°‡∏∑‡πà‡∏≠ `current_year` ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)
- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ seed data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö `correspondence_types`, `rfa_types`, `disciplines` ‡∏Å‡πà‡∏≠‡∏ô

**Schema Details:** ‡∏î‡∏π [Implementation Guide - Section 1.1](file:///e:/np-dms/lcbp3/specs/03-implementation/document-numbering.md#11-counter-table-schema)

### 3.11.13.2. Audit Table Requirements

**Primary Table**: `document_number_audit`

**Required Columns:**
- `document_id`, `generated_number`, `counter_key` (JSON)
- `template_used`, `user_id`, `ip_address`
- Performance metrics: `retry_count`, `lock_wait_ms`, `total_duration_ms`
- `fallback_used` - tracking fallback scenarios

**Retention:** ‚â• 7 ‡∏õ‡∏µ

### 3.11.13.3. Error Log Requirements

**Primary Table**: `document_number_errors`

**Required Columns:**
- `error_type` - ENUM classification
- `error_message`, `stack_trace`, `context_data` (JSON)
- `user_id`, `ip_address`, `created_at`, `resolved_at`

## 3.11.14. Security Considerations

### 3.11.14.1. Authorization

- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **authenticated users** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ request document number
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **Project Admin** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡πÑ‡∏î‡πâ
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ **Super Admin** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà reset counter ‡πÑ‡∏î‡πâ

### 3.11.14.2. Rate Limiting

**Requirements:**
- Limit ‡∏ï‡πà‡∏≠ user: **10 requests/minute** (prevent abuse)
- Limit ‡∏ï‡πà‡∏≠ IP: **50 requests/minute**

**Implementation Details:** ‡∏î‡∏π [Implementation Guide - Section 5](file:///e:/np-dms/lcbp3/specs/03-implementation/document-numbering.md#5-api-controller)

### 3.11.14.3. Audit & Compliance

**Requirements:**
- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å API call ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö document numbering
- ‡πÄ‡∏Å‡πá‡∏ö audit log ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **7 ‡∏õ‡∏µ** (‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå)
- Audit log **‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà**‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ (immutable)

---

## References

- [Implementation Guide](file:///e:/np-dms/lcbp3/specs/03-implementation/document-numbering.md)
- [Operations Guide](file:///e:/np-dms/lcbp3/specs/04-operations/document-numbering-operations.md)
- [API Design](file:///e:/np-dms/lcbp3/specs/02-architecture/api-design.md)
- [Data Dictionary](file:///e:/np-dms/lcbp3/specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md)


```
lock:docnum:{project_id}:{org_id}:{recip_id}:{type_id}:{sub}:{rfa}:{disc}:{year}
```

**Lock Configuration**:

- **TTL**: 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (auto-release ‡πÄ‡∏°‡∏∑‡πà‡∏≠ timeout)
- **Acquisition Timeout**: 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
- **Retry Delay**: 100ms (exponential backoff)
- **Drift Factor**: 0.01 (Redlock algorithm)

**Implementation (NestJS)**:

```typescript
// src/document-numbering/services/document-numbering-lock.service.ts
import Redlock from 'redlock';
import { Injectable } from '@nestjs/common';

@Injectable()
export class DocumentNumberingLockService {
  private redlock: Redlock;

  async acquireLock(counterKey: CounterKey): Promise<Lock> {
    const lockKey = this.buildLockKey(counterKey);
    return await this.redlock.acquire([lockKey], 5000); // 5s TTL
  }

  private buildLockKey(key: CounterKey): string {
    return `lock:docnum:${key.projectId}:${key.originatorOrgId}:` +
           `${key.recipientOrgId ?? 0}:${key.correspondenceTypeId}:` +
           `${key.subTypeId}:${key.rfaTypeId}:${key.disciplineId}:${key.year}`;
  }
}
```

### 3.11.5.2. Optimistic Locking

‡πÉ‡∏ä‡πâ **TypeORM Optimistic Lock** ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö `@Version()` decorator:

**Entity Definition**:

```typescript
// src/document-numbering/entities/document-number-counter.entity.ts
import { Entity, Column, PrimaryColumn, VersionColumn } from 'typeorm';

@Entity('document_number_counters')
export class DocumentNumberCounter {
  @PrimaryColumn({ name: 'project_id' })
  projectId: number;

  @PrimaryColumn({ name: 'originator_organization_id' })
  originatorOrganizationId: number;

  @PrimaryColumn({ name: 'recipient_organization_id', nullable: true })
  recipientOrganizationId: number | null;

  @PrimaryColumn({ name: 'correspondence_type_id' })
  correspondenceTypeId: number;

  @PrimaryColumn({ name: 'sub_type_id', default: 0 })
  subTypeId: number;

  @PrimaryColumn({ name: 'rfa_type_id', default: 0 })
  rfaTypeId: number;

  @PrimaryColumn({ name: 'discipline_id', default: 0 })
  disciplineId: number;

  @PrimaryColumn({ name: 'current_year' })
  currentYear: number;

  @VersionColumn({ name: 'version' })
  version: number;

  @Column({ name: 'last_number', default: 0 })
  lastNumber: number;
}
```

**Transaction Handling**:

```typescript
// ‡πÉ‡∏ä‡πâ TypeORM Transaction + Optimistic Lock
await this.connection.transaction(async (manager) => {
  const counter = await manager.findOne(DocumentNumberCounter, {
    where: counterKey
  });

  counter.lastNumber += 1;
  await manager.save(counter); // auto-check version
});
```

‡∏´‡∏≤‡∏Å version conflict ‚Üí TypeORM throw `OptimisticLockVersionMismatchError` ‚Üí retry

### 3.11.5.3. Database Constraints

**Unique Constraints**:

```sql
-- ‡∏ö‡∏ô documents table
ALTER TABLE documents
ADD CONSTRAINT uq_document_number UNIQUE (document_number);
```

**Foreign Key Constraints**:

- `project_id` ‚Üí `projects(id)` ON DELETE CASCADE
- `originator_organization_id` ‚Üí `organizations(id)` ON DELETE CASCADE
- `recipient_organization_id` ‚Üí `organizations(id)` ON DELETE CASCADE
- `correspondence_type_id` ‚Üí `correspondence_types(id)` ON DELETE CASCADE

**Check Constraints**:

```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ last_number ‚â• 0
ALTER TABLE document_number_counters
ADD CONSTRAINT chk_last_number_positive CHECK (last_number >= 0);

-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ current_year ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ ‡∏Ñ.‡∏®. ‡∏ó‡∏µ‡πà‡∏™‡∏°‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏°‡∏ú‡∏•
ALTER TABLE document_number_counters
ADD CONSTRAINT chk_current_year_valid
CHECK (current_year BETWEEN 2020 AND 2100);
```

## 3.11.6. Retry Mechanism & Error Handling

### 3.11.6.1. Scenario 1: Redis Unavailable

**Fallback Strategy**: Database-only Pessimistic Locking

**Implementation**:

```typescript
// src/document-numbering/services/document-numbering.service.ts
@Injectable()
export class DocumentNumberingService {
  async generateDocumentNumber(dto: GenerateNumberDto): Promise<string> {
    try {
      // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÉ‡∏ä‡πâ Redis lock ‡∏Å‡πà‡∏≠‡∏ô
      return await this.generateWithRedisLock(dto);
    } catch (error) {
      if (error instanceof RedisConnectionError) {
        // Fallback: ‡πÉ‡∏ä‡πâ database lock
        this.logger.warn('Redis unavailable, falling back to DB lock');
        await this.alertOpsTeam('redis_unavailable');
        return await this.generateWithDbLock(dto);
      }
      throw error;
    }
  }

  private async generateWithDbLock(dto: GenerateNumberDto): Promise<string> {
    return await this.connection.transaction(async (manager) => {
      // SELECT ... FOR UPDATE = Pessimistic Lock
      const counter = await manager
        .createQueryBuilder(DocumentNumberCounter, 'c')
        .where(counterKeyCondition)
        .setLock('pessimistic_write')
        .getOne();

      counter.lastNumber += 1;
      await manager.save(counter);
      return this.formatNumber(counter);
    });
  }
}
```

**Monitoring**:

- Log warning ‡∏û‡∏£‡πâ‡∏≠‡∏° context (project_id, user_id, timestamp)
- Alert Ops Team ‡∏ú‡πà‡∏≤‡∏ô Slack/Email
- ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà performance ‡∏≠‡∏≤‡∏à‡∏•‡∏î‡∏•‡∏á 30-50%

### 3.11.6.2. Scenario 2: Lock Acquisition Timeout

**Retry Strategy**: Exponential Backoff with Jitter

```typescript
// ‡πÉ‡∏ä‡πâ @nestjs/common Retry Decorator ‡∏´‡∏£‡∏∑‡∏≠ custom retry logic
import { retry } from 'rxjs/operators';

const RETRY_CONFIG = {
  maxRetries: 5,
  delays: [1000, 2000, 4000, 8000, 16000], // exponential backoff
  jitter: 0.1 // ‡πÄ‡∏û‡∏¥‡πà‡∏° randomness ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô thundering herd
};

async acquireLockWithRetry(key: CounterKey): Promise<Lock> {
  for (let i = 0; i < RETRY_CONFIG.maxRetries; i++) {
    try {
      return await this.lockService.acquireLock(key);
    } catch (error) {
      if (i === RETRY_CONFIG.maxRetries - 1) {
        throw new ServiceUnavailableException(
          '‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∏‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á'
        );
      }
      const delay = RETRY_CONFIG.delays[i];
      const jitter = delay * RETRY_CONFIG.jitter * Math.random();
      await this.sleep(delay + jitter);
    }
  }
}
```

**Response**:

- HTTP Status: `503 Service Temporarily Unavailable`
- Response Body:

  ```json
  {
    "statusCode": 503,
    "message": "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∏‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á",
    "error": "Service Unavailable",
    "retryAfter": 30
  }
  ```

### 3.11.6.3. Scenario 3: Version Conflict (Optimistic Lock)

**Retry Strategy**: Immediate Retry (2 attempts)

```typescript
async incrementCounter(counterKey: CounterKey): Promise<number> {
  const MAX_RETRIES = 2;

  for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
    try {
      return await this.connection.transaction(async (manager) => {
        const counter = await manager.findOne(
          DocumentNumberCounter,
          { where: counterKey }
        );

        counter.lastNumber += 1;
        await manager.save(counter); // Version check ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        return counter.lastNumber;
      });
    } catch (error) {
      if (error instanceof OptimisticLockVersionMismatchError) {
        this.logger.warn(`Version conflict, retry ${attempt + 1}/${MAX_RETRIES}`);
        if (attempt === MAX_RETRIES - 1) {
          throw new ConflictException('‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
        }
        // Retry ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡πÑ‡∏°‡πà‡∏°‡∏µ delay)
        continue;
      }
      throw error;
    }
  }
}
```

**Response**:

- HTTP Status: `409 Conflict`
- Frontend Action: Auto-retry ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏™‡∏î‡∏á toast notification

### 3.11.6.4. Scenario 4: Database Connection Error

**Retry Strategy**: Exponential Backoff (3 attempts)

```typescript
const DB_RETRY_CONFIG = {
  maxRetries: 3,
  delays: [1000, 2000, 4000]
};

// TypeORM connection retry (‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô ormconfig)
{
  type: 'mysql',
  extra: {
    connectionLimit: 10,
    acquireTimeout: 10000,
    // Retry connection 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
    retryAttempts: 3,
    retryDelay: 1000
  }
}
```

**Response**:

- HTTP Status: `500 Internal Server Error`
- Response Body:

  ```json
  {
    "statusCode": 500,
    "message": "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö",
    "error": "Internal Server Error",
    "ref": "ERR-20250102-1234-ABCD"
  }
  ```

- Alerting: ‡∏™‡πà‡∏á PagerDuty/Slack alert ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (severity: CRITICAL)

## 3.11.7. Configuration Management

### 3.11.7.1. Admin Panel Configuration

**Features**:

- Project Admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏≥‡∏´‡∏ô‡∏î/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡∏ú‡πà‡∏≤‡∏ô Web UI
- Preview document number ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
- Template validation ‡πÅ‡∏ö‡∏ö real-time

**Template Validation Logic**:

```typescript
// src/document-numbering/validators/template.validator.ts
import { Injectable } from '@nestjs/common';

@Injectable()
export class TemplateValidator {
  private readonly ALLOWED_TOKENS = [
    'PROJECT', 'ORIGINATOR', 'RECIPIENT', 'CORR_TYPE',
    'SUB_TYPE', 'RFA_TYPE', 'DISCIPLINE', 'SEQ', 'YEAR', 'REV'
  ];

  validate(template: string, correspondenceType: string): ValidationResult {
    const tokens = this.extractTokens(template);
    const errors: string[] = [];

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Token ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å
    for (const token of tokens) {
      if (!this.ALLOWED_TOKENS.includes(token.name)) {
        errors.push(`Unknown token: {${token.name}}`);
      }
    }

    // ‡∏Å‡∏é‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
    if (correspondenceType === 'RFA') {
      if (!tokens.some(t => t.name === 'PROJECT')) {
        errors.push('RFA template ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ {PROJECT}');
      }
    }

    if (correspondenceType === 'TRANSMITTAL') {
      if (!tokens.some(t => t.name === 'SUB_TYPE')) {
        errors.push('TRANSMITTAL template ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ {SUB_TYPE}');
      }
    }

    return { valid: errors.length === 0, errors };
  }
}
```

**API Endpoint**:

```typescript
// PUT /api/v1/document-numbering/configs/:configId
@Put('configs/:configId')
@Roles('PROJECT_ADMIN')
async updateTemplate(
  @Param('configId') configId: number,
  @Body() dto: UpdateTemplateDto
): Promise<DocumentNumberConfig> {
  // Validate template
  const validation = await this.templateValidator.validate(
    dto.template,
    dto.correspondenceType
  );

  if (!validation.valid) {
    throw new BadRequestException(validation.errors);
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å template (‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß)
  return await this.configService.update(configId, dto);
}
```

### 3.11.7.2. Template Versioning

**Database Table**: `document_number_config_history`

```sql
CREATE TABLE document_number_config_history (
  id INT AUTO_INCREMENT PRIMARY KEY,
  config_id INT NOT NULL,
  template_before TEXT,
  template_after TEXT NOT NULL,
  changed_by INT NOT NULL,
  changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  change_reason TEXT,

  FOREIGN KEY (config_id) REFERENCES document_number_configs(id),
  FOREIGN KEY (changed_by) REFERENCES users(id)
) ENGINE=InnoDB COMMENT='Template Change History';
```

**Audit Trail Implementation**:

```typescript
@Injectable()
export class ConfigHistoryService {
  async recordChange(
    configId: number,
    oldTemplate: string,
    newTemplate: string,
    userId: number,
    reason: string
  ): Promise<void> {
    await this.historyRepo.save({
      configId,
      templateBefore: oldTemplate,
      templateAfter: newTemplate,
      changedBy: userId,
      changeReason: reason
    });
  }

  async rollback(configId: number, historyId: number): Promise<void> {
    const history = await this.historyRepo.findOne({ where: { id: historyId }});
    await this.configService.update(configId, {
      template: history.templateBefore
    });
  }
}
```

### 3.11.7.3. Counter Reset Policy

**Automatic Reset**:

- **Yearly Reset**: ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏° (00:00:00 ICT)
  - ‡πÉ‡∏ä‡πâ **BullMQ Cron Job**:

  ```typescript
  // src/document-numbering/jobs/counter-reset.job.ts
  @Processor('document-numbering')
  export class CounterResetJob {
    @Cron('0 0 1 1 *') // 1 Jan every year
    async handleYearlyReset() {
      const newYear = new Date().getFullYear();

      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á reset counter ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ counter ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° current_year ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
      // ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° counter ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà
      this.logger.log(`Year changed to ${newYear}, counters ready`);
    }
  }
  ```

**Manual Reset** (Admin only):

```typescript
// POST /api/v1/document-numbering/configs/:configId/reset-counter
@Post('configs/:configId/reset-counter')
@Roles('SUPER_ADMIN')
@RequireApproval() // Custom decorator: ‡∏ï‡πâ‡∏≠‡∏á approve ‡∏à‡∏≤‡∏Å 2 admins
async resetCounter(
  @Param('configId') configId: number,
  @Body() dto: ResetCounterDto
): Promise<void> {
  // Validate reason
  if (!dto.reason || dto.reason.length < 20) {
    throw new BadRequestException('‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 20 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
  }

  // Audit log
  await this.auditService.logCounterReset({
    configId,
    userId: req.user.id,
    reason: dto.reason,
    previousValue: counter.lastNumber
  });

  // Reset
  await this.counterService.reset(configId);
}

## 3.11.8. Audit Trail

### 3.11.8.1. ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Audit Log

**Database Table**: `document_number_audit`

```sql
CREATE TABLE document_number_audit (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  document_id INT NOT NULL,
  generated_number VARCHAR(100) NOT NULL,
  counter_key JSON NOT NULL COMMENT 'Counter key used (JSON format)',
  template_used VARCHAR(200) NOT NULL,
  user_id INT NOT NULL,
  ip_address VARCHAR(45),
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  -- Performance & Error Tracking
  retry_count INT DEFAULT 0,
  lock_wait_ms INT COMMENT 'Lock acquisition time in milliseconds',
  total_duration_ms INT COMMENT 'Total generation time',
  fallback_used ENUM('NONE', 'DB_LOCK', 'RETRY') DEFAULT 'NONE',

  INDEX idx_document_id (document_id),
  INDEX idx_user_id (user_id),
  INDEX idx_created_at (created_at),
  FOREIGN KEY (document_id) REFERENCES documents(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id) REFERENCES users(id)
) ENGINE=InnoDB COMMENT='Document Number Generation Audit Trail';
```

**Audit Service Implementation**:

```typescript
// src/document-numbering/services/audit.service.ts
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';

@Injectable()
export class DocumentNumberAuditService {
  async logGeneration(data: AuditLogData): Promise<void> {
    await this.auditRepo.save({
      documentId: data.documentId,
      generatedNumber: data.number,
      counterKey: JSON.stringify(data.counterKey),
      templateUsed: data.template,
      userId: data.userId,
      ipAddress: data.ipAddress,
      userAgent: data.userAgent,
      retryCount: data.retryCount ?? 0,
      lockWaitMs: data.lockWaitMs,
      totalDurationMs: data.totalDurationMs,
      fallbackUsed: data.fallbackUsed ?? 'NONE'
    });
  }
}
```

**Usage in Service**:

```typescript
@Injectable()
export class DocumentNumberingService {
  async generateDocumentNumber(dto: GenerateNumberDto, req: Request) {
    const startTime = Date.now();
    let lockWaitMs = 0;
    let retryCount = 0;
    let fallbackUsed = 'NONE';

    try {
      // ... generate logic ...
      const number = await this.doGenerate(dto);

      // Audit log
      await this.auditService.logGeneration({
        documentId: dto.documentId,
        number,
        counterKey: dto.counterKey,
        template: config.template,
        userId: req.user.id,
        ipAddress: req.ip,
        userAgent: req.headers['user-agent'],
        retryCount,
        lockWaitMs,
        totalDurationMs: Date.now() - startTime,
        fallbackUsed
      });

      return number;
    } catch (error) {
      // Log error separately
      await this.errorLogService.log(error, dto);
      throw error;
    }
  }
}
```

### 3.11.8.2. Conflict & Error Logging

**Separate Error Log Table**: `document_number_errors`

```sql
CREATE TABLE document_number_errors (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  error_type ENUM(
    'LOCK_TIMEOUT',
    'VERSION_CONFLICT',
    'DB_ERROR',
    'REDIS_ERROR',
    'VALIDATION_ERROR'
  ) NOT NULL,
  error_message TEXT,
  stack_trace TEXT,
  context_data JSON COMMENT 'Request context (user, project, etc.)',
  user_id INT,
  ip_address VARCHAR(45),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  resolved_at TIMESTAMP NULL,

  INDEX idx_error_type (error_type),
  INDEX idx_created_at (created_at),
  INDEX idx_user_id (user_id)
) ENGINE=InnoDB COMMENT='Document Numbering Error Log';
```

**Error Logging Service**:

```typescript
@Injectable()
export class ErrorLogService {
  async log(error: Error, context: any): Promise<void> {
    const errorType = this.classifyError(error);

    await this.errorRepo.save({
      errorType,
      errorMessage: error.message,
      stackTrace: error.stack,
      contextData: JSON.stringify(context),
      userId: context.userId,
      ipAddress: context.ipAddress
    });

    // Alert if critical
    if (this.isCritical(errorType)) {
      await this.alertService.sendAlert({
        severity: 'CRITICAL',
        title: `Document Numbering Error: ${errorType}`,
        details: error.message
      });
    }
  }

  private classifyError(error: Error): string {
    if (error instanceof LockTimeoutError) return 'LOCK_TIMEOUT';
    if (error instanceof OptimisticLockVersionMismatchError) return 'VERSION_CONFLICT';
    if (error instanceof QueryFailedError) return 'DB_ERROR';
    if (error instanceof RedisConnectionError) return 'REDIS_ERROR';
    return 'UNKNOWN';
  }
}

## 3.11.9. Performance Requirements

### 3.11.9.1. Response Time

**Target Response Times**:
- **95th percentile**: ‚â§ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
- **99th percentile**: ‚â§ 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
- **Normal operation** (‡πÑ‡∏°‡πà‡∏°‡∏µ retry): ‚â§ 500ms

**Performance Optimization Strategies**:

```typescript
// 1. Database Connection Pooling
{
  type: 'mysql',
  extra: {
    connectionLimit: 20,      // Pool size
    queueLimit: 0,            // Unlimited queue
    acquireTimeout: 10000     // 10s timeout
  }
}

// 2. Redis Connection Pooling
import IORedis from 'ioredis';

const redis = new IORedis({
  host: process.env.REDIS_HOST,
  port: parseInt(process.env.REDIS_PORT),
  maxRetriesPerRequest: 3,
  enableReadyCheck: true,
  lazyConnect: false,
  // Connection pool
  poolSize: 10
});

// 3. Query Optimization
// ‡πÉ‡∏ä‡πâ Index-covered queries
const counter = await this.counterRepo
  .createQueryBuilder('c')
  .where('c.project_id = :projectId', { projectId })
  .andWhere('c.correspondence_type_id = :typeId', { typeId })
  .andWhere('c.current_year = :year', { year })
  .useIndex('idx_counter_lookup')  // Force index usage
  .getOne();
```

**Performance Monitoring**:

```typescript
// Prometheus metrics
import { Counter, Histogram } from 'prom-client';

const generationDuration = new Histogram({
  name: 'docnum_generation_duration_seconds',
  help: 'Document number generation duration',
  labelNames: ['project', 'type', 'status'],
  buckets: [0.1, 0.5, 1, 2, 5, 10]
});

// Usage
const timer = generationDuration.startTimer();
try {
  const number = await this.generate(dto);
  timer({ status: 'success' });
} catch (error) {
  timer({ status: 'error' });
  throw error;
}
```

### 3.11.9.2. Throughput

**Capacity Requirements**:

- **Normal load**: ‚â• 50 requests/second
- **Peak load**: ‚â• 100 requests/second (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏£‡πà‡∏á‡∏á‡∏≤‡∏ô)
- **Burst capacity**: ‚â• 200 requests/second (short duration)

**Load Balancing Strategy**:

```yaml
# docker-compose.yml
services:
  backend:
    image: lcbp3-backend:latest
    deploy:
      replicas: 3              # 3 instances
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
```

```nginx
# nginx.conf - Load Balancing Configuration
upstream backend {
  least_conn;  # Least connections algorithm
  server backend:3000 max_fails=3 fail_timeout=30s;
  server backend:3001 max_fails=3 fail_timeout=30s;
  server backend:3002 max_fails=3 fail_timeout=30s;
}

server {
  location /api/v1/documents/ {
    proxy_pass http://backend;
    proxy_next_upstream error timeout;
    proxy_connect_timeout 10s;
    proxy_read_timeout 30s;
  }
}
```

**Rate Limiting**:

```typescript
// ‡πÉ‡∏ä‡πâ @nestjs/throttler
import { ThrottlerGuard } from '@nestjs/throttler';

@Controller('document-numbering')
@UseGuards(ThrottlerGuard)
export class DocumentNumberingController {
  @Throttle(10, 60)  // 10 requests per 60 seconds per user
  @Post('generate')
  async generate(@Body() dto: GenerateNumberDto) {
    return await this.service.generate(dto);
  }
}
```

### 3.11.9.3. Availability

**SLA Targets**:

- **Uptime**: ‚â• 99.5% (excluding planned maintenance)
- **Maximum downtime**: ‚â§ 3.6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
- **Recovery Time Objective (RTO)**: ‚â§ 30 ‡∏ô‡∏≤‡∏ó‡∏µ
- **Recovery Point Objective (RPO)**: ‚â§ 5 ‡∏ô‡∏≤‡∏ó‡∏µ

**High Availability Setup**:

```yaml
# High Availability Architecture
services:
  # MariaDB - Master/Replica
  mariadb-master:
    image: mariadb:11.8
    environment:
      MYSQL_REPLICATION_MODE: master

  mariadb-replica:
    image: mariadb:11.8
    environment:
      MYSQL_REPLICATION_MODE: slave
      MYSQL_MASTER_HOST: mariadb-master

  # Redis - Sentinel Mode
  redis-master:
    image: redis:7-alpine
    command: redis-server --appendonly yes

  redis-replica:
    image: redis:7-alpine
    command: redis-server --replicaof redis-master 6379

  redis-sentinel:
    image: redis:7-alpine
    command: >
      redis-sentinel /etc/redis/sentinel.conf
      --sentinel monitor mymaster redis-master 6379 2
```

**Health Checks**:

```typescript
// src/health/health.controller.ts
import { HealthCheck, HealthCheckService, TypeOrmHealthIndicator } from '@nestjs/terminus';

@Controller('health')
export class HealthController {
  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () => this.db.pingCheck('database'),
      () => this.redis.pingCheck('redis'),
      () => this.customHealthCheck()
    ]);
  }

  private async customHealthCheck() {
    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö generate document number
    const canGenerate = await this.testGeneration();
    return { documentNumbering: { status: canGenerate ? 'up' : 'down' }};
  }
}

## 3.11.10. Monitoring & Alerting

### 3.11.10.1. Metrics Collection

**Prometheus Metrics Implementation**:

```typescript
// src/document-numbering/metrics/metrics.service.ts
import { Injectable } from '@nestjs/common';
import { Counter, Histogram, Gauge } from 'prom-client';

@Injectable()
export class DocumentNumberingMetrics {
  // Lock acquisition metrics
  private lockAcquisitionDuration = new Histogram({
    name: 'docnum_lock_acquisition_duration_ms',
    help: 'Lock acquisition time in milliseconds',
    labelNames: ['project', 'type'],
    buckets: [10, 50, 100, 200, 500, 1000, 2000, 5000]
  });

  private lockAcquisitionFailures = new Counter({
    name: 'docnum_lock_acquisition_failures_total',
    help: 'Total number of lock acquisition failures',
    labelNames: ['project', 'type', 'reason']
  });

  // Generation metrics
  private generationDuration = new Histogram({
    name: 'docnum_generation_duration_ms',
    help: 'Total document number generation time',
    labelNames: ['project', 'type', 'status'],
    buckets: [100, 200, 500, 1000, 2000, 5000]
  });

  private retryCount = new Histogram({
    name: 'docnum_retry_count',
    help: 'Number of retries per generation',
    labelNames: ['project', 'type'],
    buckets: [0, 1, 2, 3, 5, 10]
  });

  // Connection health
  private redisConnectionStatus = new Gauge({
    name: 'docnum_redis_connection_status',
    help: 'Redis connection status (1=up, 0=down)'
  });

  private dbConnectionPoolUsage = new Gauge({
    name: 'docnum_db_connection_pool_usage',
    help: 'Database connection pool usage percentage'
  });
}
```

### 3.11.10.2. Alert Rules

**Prometheus Alert Rules** (`prometheus/alerts.yml`):

```yaml
groups:
  - name: document_numbering_alerts
    interval: 30s
    rules:
      # CRITICAL: Redis unavailable
      - alert: RedisUnavailable
        expr: docnum_redis_connection_status == 0
        for: 1m
        labels:
          severity: critical
          component: document-numbering
        annotations:
          summary: "Redis is unavailable for document numbering"
          description: "System is falling back to DB-only locking"

      # CRITICAL: High lock failure rate
      - alert: HighLockFailureRate
        expr: |
          rate(docnum_lock_acquisition_failures_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Lock acquisition failure rate > 10%"
          description: "Check Redis and database performance"

      # WARNING: Elevated lock failure rate
      - alert: ElevatedLockFailureRate
        expr: |
          rate(docnum_lock_acquisition_failures_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Lock acquisition failure rate > 5%"

      # WARNING: Slow lock acquisition
      - alert: SlowLockAcquisition
        expr: |
          histogram_quantile(0.95,
            rate(docnum_lock_acquisition_duration_ms_bucket[5m])
          ) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "P95 lock acquisition time > 1 second"

      # WARNING: High retry count
      - alert: HighRetryCount
        expr: |
          sum by (project) (
            rate(docnum_retry_count_sum[1h])
          ) > 100
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "Retry count > 100 per hour in project {{ $labels.project }}"

      # WARNING: Slow generation
      - alert: SlowDocumentNumberGeneration
        expr: |
          histogram_quantile(0.95,
            rate(docnum_generation_duration_ms_bucket[5m])
          ) > 2000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "P95 generation time > 2 seconds"
```

**AlertManager Configuration** (`alertmanager/config.yml`):

```yaml
route:
  group_by: ['alertname', 'severity']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  receiver: 'ops-team'
  routes:
    # CRITICAL alerts ‚Üí PagerDuty + Slack
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      continue: true

    # WARNING alerts ‚Üí Slack only
    - match:
        severity: warning
      receiver: 'slack-warnings'

receivers:
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: <SERVICE_KEY>
        description: '{{ .CommonAnnotations.summary }}'

  - name: 'slack-warnings'
    slack_configs:
      - api_url: <SLACK_WEBHOOK>
        channel: '#lcbp3-alerts'
        title: '‚ö†Ô∏è {{ .GroupLabels.alertname }}'
        text: '{{ .CommonAnnotations.description }}'

  - name: 'ops-team'
    email_configs:
      - to: 'ops@example.com'
```

### 3.11.10.3. Grafana Dashboard

**Dashboard Configuration** (`grafana/dashboards/document-numbering.json`):

```json
{
  "title": "Document Numbering Performance",
  "panels": [
    {
      "title": "Lock Acquisition Success Rate",
      "targets": [{
        "expr": "1 - (rate(docnum_lock_acquisition_failures_total[5m]) / rate(docnum_lock_acquisition_total[5m]))"
      }],
      "type": "graph",
      "gridPos": { "x": 0, "y": 0, "w": 12, "h": 8 }
    },
    {
      "title": "Lock Acquisition Time (Percentiles)",
      "targets": [
        {
          "expr": "histogram_quantile(0.50, rate(docnum_lock_acquisition_duration_ms_bucket[5m]))",
          "legendFormat": "P50"
        },
        {
          "expr": "histogram_quantile(0.95, rate(docnum_lock_acquisition_duration_ms_bucket[5m]))",
          "legendFormat": "P95"
        },
        {
          "expr": "histogram_quantile(0.99, rate(docnum_lock_acquisition_duration_ms_bucket[5m]))",
          "legendFormat": "P99"
        }
      ],
      "type": "graph",
      "gridPos": { "x": 12, "y": 0, "w": 12, "h": 8 }
    },
    {
      "title": "Generation Rate (per minute)",
      "targets": [{
        "expr": "sum(rate(docnum_generation_duration_ms_count[1m])) * 60"
      }],
      "type": "stat",
      "gridPos": { "x": 0, "y": 8, "w": 6, "h": 4 }
    },
    {
      "title": "Redis Connection Status",
      "targets": [{
        "expr": "docnum_redis_connection_status"
      }],
      "type": "stat",
      "gridPos": { "x": 6, "y": 8, "w": 6, "h": 4 },
      "thresholds": {
        "mode": "absolute",
        "steps": [
          { "value": 0, "color": "red" },
          { "value": 1, "color": "green" }
        ]
      }
    },
    {
      "title": "Error Rate by Type",
      "targets": [{
        "expr": "sum by (reason) (rate(docnum_lock_acquisition_failures_total[5m]))"
      }],
      "type": "graph",
      "gridPos": { "x": 12, "y": 8, "w": 12, "h": 8 }
    }
  ]
}
```

**Key Dashboard Panels**:

- **Lock Acquisition Success Rate**: Real-time success %
- **Lock Wait Time Percentiles**: P50, P95, P99 latency
- **Generation Rate**: Documents/minute
- **Error Breakdown**: By error type (LOCK_TIMEOUT, VERSION_CONFLICT, etc.)
- **Redis/DB Health**: Connection status
- **Retry Distribution**: Histogram of retry counts

## 3.11.12. API Reference

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á API endpoints ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô `specs/02-architecture/api-design.md`):

- `POST /api/v1/documents/{documentId}/generate-number` - ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- `GET /api/v1/document-numbering/configs` - ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ template
- `PUT /api/v1/document-numbering/configs/{configId}` - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template (Admin only)
- `POST /api/v1/document-numbering/configs/{configId}/reset-counter` - Reset counter (Admin only)

## 3.11.13. Database Schema Reference

‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ñ‡∏∂‡∏á tables ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÉ‡∏ô `specs/04-data-dictionary/4_Data_Dictionary_V1_4_4.md`):

- `document_number_configs` - ‡πÄ‡∏Å‡πá‡∏ö template ‡πÅ‡∏•‡∏∞ counter configuration
- `document_number_counters` - ‡πÄ‡∏Å‡πá‡∏ö current counter value
- `document_number_audit` - ‡πÄ‡∏Å‡πá‡∏ö audit trail
- `documents` - ‡πÄ‡∏Å‡πá‡∏ö document number ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á

## 3.11.14. Database Schema Requirements

### 3.11.14.1. Counter Table Schema

‡∏ï‡∏≤‡∏£‡∏≤‡∏á `document_number_counters` ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:

```sql
CREATE TABLE document_number_counters (
  project_id INT NOT NULL,
  originator_organization_id INT NOT NULL,
  recipient_organization_id INT NULL,  -- NULL for RFA
  correspondence_type_id INT NOT NULL,
  sub_type_id INT DEFAULT 0,           -- for TRANSMITTAL
  rfa_type_id INT DEFAULT 0,           -- for RFA
  discipline_id INT DEFAULT 0,         -- for RFA
  current_year INT NOT NULL,
  version INT DEFAULT 0 NOT NULL,      -- Optimistic Lock
  last_number INT DEFAULT 0,

  PRIMARY KEY (
    project_id,
    originator_organization_id,
    COALESCE(recipient_organization_id, 0),
    correspondence_type_id,
    sub_type_id,
    rfa_type_id,
    discipline_id,
    current_year
  ),

  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
  FOREIGN KEY (originator_organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
  FOREIGN KEY (recipient_organization_id) REFERENCES organizations(id) ON DELETE CASCADE,
  FOREIGN KEY (correspondence_type_id) REFERENCES correspondence_types(id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_general_ci
  COMMENT = '‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏Å‡πá‡∏ö Running Number Counters';
```

### 3.11.14.2. Index Requirements

```sql
-- Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Performance
CREATE INDEX idx_counter_lookup
ON document_number_counters (
  project_id,
  correspondence_type_id,
  current_year
);

-- Index ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Originator lookup
CREATE INDEX idx_counter_org
ON document_number_counters (
  originator_organization_id,
  current_year
);
```

### 3.11.14.3. Important Notes

> **üí° Counter Key Design**
>
> - ‡πÉ‡∏ä‡πâ `COALESCE(recipient_organization_id, 0)` ‡πÉ‡∏ô Primary Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö NULL
> - `version` column ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Optimistic Locking (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô race condition)
> - `last_number` ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 0 ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡∏ó‡∏µ‡∏•‡∏∞ 1
> - Counter reset ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ (‡πÄ‡∏°‡∏∑‡πà‡∏≠ `current_year` ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)

> **‚ö†Ô∏è Migration Notes**
>
> - ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ backward compatibility
> - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á table ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏ï‡∏≤‡∏° schema ‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô
> - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ seed data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö `correspondence_types`, `rfa_types`, `disciplines` ‡∏Å‡πà‡∏≠‡∏ô

### 3.11.14.4. Example Counter Records

```sql
-- Example: LETTER from ‡∏Ñ‡∏Ñ‡∏á. to ‡∏™‡∏Ñ‡∏â.3 in LCBP3-C2 year 2025
INSERT INTO document_number_counters (
  project_id, originator_organization_id, recipient_organization_id,
  correspondence_type_id, sub_type_id, rfa_type_id, discipline_id,
  current_year, version, last_number
) VALUES (
  2,      -- LCBP3-C2
  22,     -- ‡∏Ñ‡∏Ñ‡∏á.
  10,     -- ‡∏™‡∏Ñ‡∏â.3
  6,      -- LETTER
  0, 0, 0,
  2025, 0, 0
);

-- Example: RFA from ‡∏ú‡∏£‡∏°.2 in LCBP3-C2, discipline TER, type RPT, year 2025
INSERT INTO document_number_counters (
  project_id, originator_organization_id, recipient_organization_id,
  correspondence_type_id, sub_type_id, rfa_type_id, discipline_id,
  current_year, version, last_number
) VALUES (
  2,      -- LCBP3-C2
  42,     -- ‡∏ú‡∏£‡∏°.2
  NULL,   -- RFA ‡πÑ‡∏°‡πà‡∏°‡∏µ specific recipient
  1,      -- RFA
  0,
  18,     -- RPT (Report)
  5,      -- TER (Terminal)
  2025, 0, 0
);
```

## 3.11.15. Security Considerations

### 3.11.14.1. Authorization

- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ authenticated users ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ request document number
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Project Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç template ‡πÑ‡∏î‡πâ
- ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Super Admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà reset counter ‡πÑ‡∏î‡πâ

### 3.11.14.2. Rate Limiting

- Limit ‡∏ï‡πà‡∏≠ user: **10 requests/minute** (prevent abuse)
- Limit ‡∏ï‡πà‡∏≠ IP: **50 requests/minute**

### 3.11.14.3. Audit & Compliance

- ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å API call ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö document numbering
- ‡πÄ‡∏Å‡πá‡∏ö audit log ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ **7 ‡∏õ‡∏µ** (‡∏ï‡∏≤‡∏° ‡∏û.‡∏£.‡∏ö. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå)
